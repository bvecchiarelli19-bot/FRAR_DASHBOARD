<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MV-FRAR Research Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    .regime-LOW { background: #dcfce7; color: #166534; border: 2px solid #22c55e; }
    .regime-MID { background: #fef9c3; color: #854d0e; border: 2px solid #eab308; }
    .regime-HIGH { background: #fed7aa; color: #9a3412; border: 2px solid #f97316; }
    .regime-CRISIS { background: #fecaca; color: #991b1b; border: 2px solid #ef4444; }
    .time-btn { transition: all 0.15s; }
    .time-btn:hover { background: #e5e7eb; }
    .time-btn.active { background: #3b82f6; color: white; }
    .winner { background: #dcfce7; }
    
    /* Quad-specific styles */
    .quad-Q1 { background: #dbeafe; color: #1e40af; border: 2px solid #3b82f6; }
    .quad-Q2 { background: #fef3c7; color: #92400e; border: 2px solid #f59e0b; }
    .quad-Q3 { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }
    .quad-Q4 { background: #e0e7ff; color: #3730a3; border: 2px solid #6366f1; }
    
    .quad-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 4px;
      width: 280px;
      height: 280px;
    }
    .quad-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.3s;
      opacity: 0.4;
    }
    .quad-cell.active {
      opacity: 1;
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .quad-cell-Q1 { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; }
    .quad-cell-Q2 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; }
    .quad-cell-Q3 { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 2px solid #ef4444; }
    .quad-cell-Q4 { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: 2px solid #6366f1; }
    
    .confidence-HIGH { color: #059669; }
    .confidence-MEDIUM { color: #d97706; }
    .confidence-LOW { color: #dc2626; }
    
    .strength-STRONG { background: #dcfce7; color: #166534; }
    .strength-MODERATE { background: #fef9c3; color: #854d0e; }
    .strength-WEAK { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  
  <div id="loading" class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <div class="text-4xl mb-4">üìä</div>
      <p class="text-gray-600">Loading dashboard data...</p>
    </div>
  </div>
  
  <div id="error" class="hidden max-w-2xl mx-auto mt-12 bg-red-50 border border-red-200 rounded-lg p-6">
    <h2 class="text-xl font-bold text-red-800 mb-4">Data Loading Failed</h2>
    <div id="error-details" class="bg-white rounded p-4 border border-red-200 font-mono text-sm text-red-600"></div>
  </div>
  
  <div id="app" class="hidden">
    <header class="bg-white border-b shadow-sm">
      <div class="max-w-7xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">MV-FRAR Research Dashboard</h1>
            <p class="text-sm text-gray-500">Version <span id="header-version">-</span></p>
          </div>
          <div class="flex items-center gap-6">
            <div class="text-right text-xs">
              <p class="text-gray-400">Signal Date</p>
              <p id="header-signal-date" class="font-mono font-semibold">-</p>
            </div>
            <div class="flex gap-2">
              <span id="header-regime" class="inline-block px-3 py-1 text-sm font-semibold rounded-full regime-LOW">-</span>
              <span id="header-quad" class="inline-block px-3 py-1 text-sm font-semibold rounded-full quad-Q1">-</span>
            </div>
          </div>
        </div>
      </div>
    </header>
    
    <nav class="bg-white border-b sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex gap-1 overflow-x-auto" id="tabs">
          <button onclick="showTab('overview')" id="tab-overview" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700 tab-active">Overview</button>
          <button onclick="showTab('quad')" id="tab-quad" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Quad</button>
          <button onclick="showTab('signal')" id="tab-signal" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Signal</button>
          <button onclick="showTab('drivers')" id="tab-drivers" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Risk Drivers</button>
          <button onclick="showTab('regime')" id="tab-regime" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Regimes</button>
          <button onclick="showTab('vs6040')" id="tab-vs6040" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">vs 60/40</button>
          <button onclick="showTab('performance')" id="tab-performance" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Performance</button>
          <button onclick="showTab('costs')" id="tab-costs" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Costs</button>
          <button onclick="showTab('health')" id="tab-health" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Health</button>
        </div>
      </div>
    </nav>
    
    <main class="max-w-7xl mx-auto px-4 py-6">
      
      <!-- Overview Tab -->
      <div id="content-overview" class="tab-content">
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <div class="bg-white rounded-lg border p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Current Status</h3>
            <div class="flex items-center gap-4 mb-4">
              <span id="overview-regime" class="inline-block px-4 py-2 text-lg font-bold rounded-full regime-LOW">-</span>
              <div>
                <p class="text-sm text-gray-500">Risk Regime</p>
                <p id="overview-regime-desc" class="text-sm font-medium">-</p>
              </div>
            </div>
            <div class="flex items-center gap-4 mb-4">
              <span id="overview-quad" class="inline-block px-4 py-2 text-lg font-bold rounded-full quad-Q1">-</span>
              <div>
                <p class="text-sm text-gray-500">Macro Regime</p>
                <p id="overview-quad-desc" class="text-sm font-medium">-</p>
              </div>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between"><span class="text-gray-500">Equity Exposure</span><span id="overview-scalar" class="font-semibold">-</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Signal Date</span><span id="overview-date" class="font-mono">-</span></div>
            </div>
          </div>
          <div class="bg-white rounded-lg border p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">FRAR Net Performance</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center p-3 bg-gray-50 rounded"><p class="text-2xl font-bold" id="overview-cagr">-</p><p class="text-xs text-gray-500">CAGR</p></div>
              <div class="text-center p-3 bg-gray-50 rounded"><p class="text-2xl font-bold" id="overview-sharpe">-</p><p class="text-xs text-gray-500">Sharpe</p></div>
              <div class="text-center p-3 bg-gray-50 rounded"><p class="text-2xl font-bold" id="overview-maxdd">-</p><p class="text-xs text-gray-500">Max DD</p></div>
              <div class="text-center p-3 bg-gray-50 rounded"><p class="text-2xl font-bold" id="overview-calmar">-</p><p class="text-xs text-gray-500">Calmar</p></div>
            </div>
          </div>
          <div class="bg-white rounded-lg border p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">vs 60/40 Benchmark</h3>
            <div class="space-y-3">
              <div class="flex justify-between"><span class="text-gray-600">CAGR Advantage</span><span id="overview-vs-cagr" class="font-semibold">-</span></div>
              <div class="flex justify-between"><span class="text-gray-600">Max DD Improvement</span><span id="overview-vs-dd" class="font-semibold">-</span></div>
              <div class="flex justify-between"><span class="text-gray-600">Metrics Won</span><span id="overview-wins" class="font-bold text-lg">-</span></div>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">Last 12 Months</h3>
          <div class="h-48"><canvas id="chart-overview"></canvas></div>
        </div>
      </div>
      
      <!-- Quad Tab (NEW) -->
      <div id="content-quad" class="tab-content hidden">
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <!-- Quad Diagram -->
          <div class="bg-white rounded-lg border p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Macro Regime</h2>
            <div class="flex justify-center mb-4">
              <div class="relative">
                <!-- Axis labels -->
                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs font-semibold text-gray-500">INFLATION ‚Üí</div>
                <div class="absolute top-1/2 -left-8 transform -translate-y-1/2 -rotate-90 text-xs font-semibold text-gray-500">GROWTH ‚Üí</div>
                
                <div class="quad-grid">
                  <div id="quad-cell-1" class="quad-cell quad-cell-Q1">
                    <span class="text-2xl font-bold">Q1</span>
                    <span class="text-xs font-semibold mt-1">Goldilocks</span>
                    <span class="text-xs opacity-75">Growth‚Üë Infl‚Üì</span>
                  </div>
                  <div id="quad-cell-2" class="quad-cell quad-cell-Q2">
                    <span class="text-2xl font-bold">Q2</span>
                    <span class="text-xs font-semibold mt-1">Reflation</span>
                    <span class="text-xs opacity-75">Growth‚Üë Infl‚Üë</span>
                  </div>
                  <div id="quad-cell-4" class="quad-cell quad-cell-Q4">
                    <span class="text-2xl font-bold">Q4</span>
                    <span class="text-xs font-semibold mt-1">Deflation</span>
                    <span class="text-xs opacity-75">Growth‚Üì Infl‚Üì</span>
                  </div>
                  <div id="quad-cell-3" class="quad-cell quad-cell-Q3">
                    <span class="text-2xl font-bold">Q3</span>
                    <span class="text-xs font-semibold mt-1">Stagflation</span>
                    <span class="text-xs opacity-75">Growth‚Üì Infl‚Üë</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="text-center">
              <span id="quad-regime-badge" class="inline-block px-4 py-2 text-lg font-bold rounded-full quad-Q1">-</span>
              <p id="quad-regime-name" class="text-sm text-gray-600 mt-2">-</p>
            </div>
          </div>
          
          <!-- Signal Details -->
          <div class="bg-white rounded-lg border p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Signal Details</h2>
            
            <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                  <p class="text-sm text-gray-500">Confirmed</p>
                  <p id="quad-confirmed" class="text-lg font-bold">-</p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-500">Confidence</p>
                  <p id="quad-confidence" class="text-lg font-bold">-</p>
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div class="p-3 border rounded-lg">
                  <p class="text-sm text-gray-500 mb-1">Growth Signal</p>
                  <p id="quad-growth-value" class="text-xl font-bold font-mono">-</p>
                  <span id="quad-growth-strength" class="inline-block px-2 py-0.5 text-xs font-semibold rounded mt-1">-</span>
                </div>
                <div class="p-3 border rounded-lg">
                  <p class="text-sm text-gray-500 mb-1">Inflation Signal</p>
                  <p id="quad-inflation-value" class="text-xl font-bold font-mono">-</p>
                  <span id="quad-inflation-strength" class="inline-block px-2 py-0.5 text-xs font-semibold rounded mt-1">-</span>
                </div>
              </div>
              
              <div id="quad-warning" class="hidden p-3 bg-amber-50 border border-amber-200 rounded-lg">
                <p class="text-sm text-amber-800">‚ö†Ô∏è <span id="quad-warning-text">-</span></p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Portfolio Allocation -->
        <div class="bg-white rounded-lg border p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Current Portfolio Allocation</h2>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-semibold text-gray-700 mb-3">Equity Portion (<span id="quad-equity-pct">-</span>)</h3>
              <div id="quad-equity-weights" class="space-y-2"></div>
            </div>
            <div>
              <h3 class="font-semibold text-gray-700 mb-3">Defensive Portion (<span id="quad-defensive-pct">-</span>)</h3>
              <div id="quad-defensive-weights" class="space-y-2"></div>
            </div>
          </div>
        </div>
        
        <!-- Quad Allocation Rules -->
        <div class="bg-white rounded-lg border p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Quad Allocation Rules</h2>
          <div class="grid md:grid-cols-4 gap-4">
            <div class="p-4 rounded-lg quad-cell-Q1">
              <h4 class="font-bold text-lg mb-2">Q1 Goldilocks</h4>
              <p class="text-xs mb-2"><strong>Growth‚Üë Inflation‚Üì</strong></p>
              <p class="text-xs"><strong>Overweight:</strong> XLK, XLF, XLI</p>
              <p class="text-xs"><strong>Underweight:</strong> XLP, XLU</p>
              <p class="text-xs mt-2"><strong>Growth Tilt:</strong> 30% QQQ + 30% SMH (LOW risk)</p>
            </div>
            <div class="p-4 rounded-lg quad-cell-Q2">
              <h4 class="font-bold text-lg mb-2">Q2 Reflation</h4>
              <p class="text-xs mb-2"><strong>Growth‚Üë Inflation‚Üë</strong></p>
              <p class="text-xs"><strong>Overweight:</strong> XLE, XLI, XLF</p>
              <p class="text-xs"><strong>Underweight:</strong> XLU, XLV</p>
              <p class="text-xs mt-2"><strong>Growth Tilt:</strong> 30% QQQ + 30% SMH (LOW risk)</p>
            </div>
            <div class="p-4 rounded-lg quad-cell-Q3">
              <h4 class="font-bold text-lg mb-2">Q3 Stagflation</h4>
              <p class="text-xs mb-2"><strong>Growth‚Üì Inflation‚Üë</strong></p>
              <p class="text-xs"><strong>Overweight:</strong> XLP, XLU, XLV, XLE</p>
              <p class="text-xs"><strong>Underweight:</strong> XLK, XLF</p>
              <p class="text-xs mt-2"><strong>Growth Tilt:</strong> None</p>
            </div>
            <div class="p-4 rounded-lg quad-cell-Q4">
              <h4 class="font-bold text-lg mb-2">Q4 Deflation</h4>
              <p class="text-xs mb-2"><strong>Growth‚Üì Inflation‚Üì</strong></p>
              <p class="text-xs"><strong>Overweight:</strong> XLP, XLU, XLV</p>
              <p class="text-xs"><strong>Underweight:</strong> XLE, XLK, XLI</p>
              <p class="text-xs mt-2"><strong>Growth Tilt:</strong> None</p>
            </div>
          </div>
          <div class="mt-4 p-3 bg-gray-50 rounded text-sm text-gray-600">
            <strong>Two-Layer System:</strong> FRAR determines <em>how much</em> risk (equity allocation), Quad determines <em>where</em> to allocate (sector tilts + growth assets).
          </div>
        </div>
      </div>
      
      <!-- Signal Tab -->
      <div id="content-signal" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Current Signal</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div><p class="text-sm text-gray-500">Signal Date</p><p id="signal-asof" class="text-lg font-semibold font-mono">-</p></div>
            <div><p class="text-sm text-gray-500">Execution Date</p><p id="signal-exec" class="text-lg font-semibold font-mono">-</p></div>
            <div><p class="text-sm text-gray-500">Regime</p><span id="signal-regime" class="inline-block px-3 py-1 text-sm font-semibold rounded-full regime-LOW">-</span></div>
            <div><p class="text-sm text-gray-500">Equity Scalar</p><p id="signal-scalar" class="text-lg font-semibold">-</p></div>
          </div>
          <div class="border-t pt-4">
            <h3 class="font-semibold text-gray-700 mb-3">Target Weights</h3>
            <div id="weights-container" class="max-w-lg"></div>
          </div>
        </div>
      </div>
      
      <!-- Risk Drivers Tab -->
      <div id="content-drivers" class="tab-content hidden">
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <div class="bg-white rounded-lg border p-4">
            <h3 class="font-semibold text-gray-700 mb-3">Current Risk Inputs</h3>
            <div class="space-y-2">
              <div class="flex justify-between"><span class="text-sm text-gray-600">Vol Percentile</span><span id="current-vol" class="font-mono">-</span></div>
              <div class="flex justify-between"><span class="text-sm text-gray-600">Hill Alpha (252d)</span><span id="current-hill" class="font-mono">-</span></div>
              <div class="flex justify-between"><span class="text-sm text-gray-600">Hurst (252d)</span><span id="current-hurst" class="font-mono">-</span></div>
              <div class="flex justify-between border-t pt-2"><span class="font-semibold">Risk Score</span><span id="current-risk" class="font-mono font-bold">-</span></div>
            </div>
          </div>
          <div class="bg-white rounded-lg border p-4">
            <h3 class="font-semibold text-gray-700 mb-3">Thresholds</h3>
            <div class="space-y-2">
              <div class="flex justify-between"><span class="text-gray-600">Median (‚ÜíMID)</span><span id="thresh-median" class="font-mono">-</span></div>
              <div class="flex justify-between"><span class="text-gray-600">75th (‚ÜíHIGH)</span><span id="thresh-75" class="font-mono">-</span></div>
            </div>
            <div class="mt-3 p-2 bg-gray-50 rounded text-xs text-gray-500">
              Thresholds are expanding quantiles calibrated on all available history.
            </div>
          </div>
          <div class="bg-white rounded-lg border p-4">
            <h3 class="font-semibold text-gray-700 mb-3">Regime Assignment</h3>
            <ul class="text-sm space-y-1 text-gray-600">
              <li><b>LOW:</b> Score &lt; median</li>
              <li><b>MID:</b> Score ‚â• median, &lt; 75th</li>
              <li><b>HIGH:</b> Score ‚â• 75th</li>
              <li><b>CRISIS:</b> HIGH + tail deterioration</li>
            </ul>
          </div>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-2">Risk Score History</h2>
          <p class="text-sm text-gray-500 mb-4">Background shading indicates regime zones. Line shows realized risk score.</p>
          <div class="h-80"><canvas id="chart-drivers"></canvas></div>
          <div class="mt-4 bg-gray-50 rounded p-3 text-sm">
            <strong>Formula:</strong> <code class="bg-gray-200 px-1 rounded">risk_score = 0.5 √ó vol_percentile + 0.3 √ó hill_risk + 0.2 √ó (1 - hurst)</code>
          </div>
        </div>
      </div>
      
      <!-- Regimes Tab -->
      <div id="content-regime" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Regime History</h2>
          <p class="text-sm text-gray-500 mb-4">Each box = 1 month</p>
          <div id="regime-timeline" class="flex gap-1 flex-wrap mb-6"></div>
          <h3 class="font-semibold text-gray-700 mb-3">Distribution</h3>
          <div id="regime-distribution"></div>
          <div class="mt-6 bg-gray-50 rounded p-4">
            <h4 class="font-semibold text-gray-700 mb-2">Regime ‚Üí Equity Scalar</h4>
            <div class="grid grid-cols-4 gap-4 text-sm text-center">
              <div><span class="inline-block px-2 py-1 rounded-full regime-LOW text-xs font-semibold">LOW</span><p class="mt-1">100%</p></div>
              <div><span class="inline-block px-2 py-1 rounded-full regime-MID text-xs font-semibold">MID</span><p class="mt-1">80%</p></div>
              <div><span class="inline-block px-2 py-1 rounded-full regime-HIGH text-xs font-semibold">HIGH</span><p class="mt-1">50%</p></div>
              <div><span class="inline-block px-2 py-1 rounded-full regime-CRISIS text-xs font-semibold">CRISIS</span><p class="mt-1">20%</p></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- vs 60/40 Tab -->
      <div id="content-vs6040" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">FRAR vs 60/40</h2>
          <table class="w-full text-sm mb-6">
            <thead><tr class="bg-gray-50">
              <th class="px-4 py-2 text-left">Metric</th>
              <th class="px-4 py-2 text-right">60/40</th>
              <th class="px-4 py-2 text-right">FRAR Net</th>
              <th class="px-4 py-2 text-center">Winner</th>
            </tr></thead>
            <tbody id="vs6040-table"></tbody>
          </table>
        </div>
        <div class="bg-white rounded-lg border p-6 mb-6">
          <h3 class="font-semibold mb-4">Equity Curves</h3>
          <div class="h-80"><canvas id="chart-vs6040"></canvas></div>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <h3 class="font-semibold mb-4">Annual Returns</h3>
          <div class="h-64"><canvas id="chart-annual"></canvas></div>
          <p id="annual-summary" class="text-sm text-gray-600 mt-4 text-center">-</p>
        </div>
      </div>
      
      <!-- Performance Tab -->
      <div id="content-performance" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Performance Summary</h2>
          <table class="w-full text-sm">
            <thead><tr class="bg-gray-50">
              <th class="px-3 py-2 text-left">Strategy</th>
              <th class="px-3 py-2 text-right">CAGR</th>
              <th class="px-3 py-2 text-right">Vol</th>
              <th class="px-3 py-2 text-right">Sharpe</th>
              <th class="px-3 py-2 text-right">Max DD</th>
              <th class="px-3 py-2 text-right">Calmar</th>
            </tr></thead>
            <tbody id="performance-table"></tbody>
          </table>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Equity Curves</h3>
            <div id="equity-time-controls" class="flex gap-1">
              <button onclick="updateEquityRange(12)" class="time-btn px-3 py-1 rounded text-sm" data-m="12">1Y</button>
              <button onclick="updateEquityRange(36)" class="time-btn px-3 py-1 rounded text-sm" data-m="36">3Y</button>
              <button onclick="updateEquityRange(60)" class="time-btn px-3 py-1 rounded text-sm" data-m="60">5Y</button>
              <button onclick="updateEquityRange(120)" class="time-btn px-3 py-1 rounded text-sm" data-m="120">10Y</button>
              <button onclick="updateEquityRange(9999)" class="time-btn px-3 py-1 rounded text-sm active" data-m="9999">Max</button>
            </div>
          </div>
          <div class="h-96"><canvas id="chart-equity"></canvas></div>
        </div>
      </div>
      
      <!-- Costs Tab -->
      <div id="content-costs" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Turnover Analysis</h2>
          <p class="text-sm text-gray-600 mb-4">Turnover separated by component to isolate signal stability from rebalancing activity.</p>
          <table class="w-full text-sm">
            <thead><tr class="bg-gray-50">
              <th class="px-3 py-2 text-left">Component</th>
              <th class="px-3 py-2 text-right">Turnover (ann.)</th>
              <th class="px-3 py-2 text-right">Cost Drag @ 10bps</th>
              <th class="px-3 py-2 text-left">Notes</th>
            </tr></thead>
            <tbody id="turnover-table"></tbody>
          </table>
          <div class="mt-4 text-xs text-gray-500">
            <p><strong>Turnover:</strong> Œ£|Œîw| (two-way). <strong>Cost:</strong> turnover √ó 10 bps round-trip.</p>
          </div>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <h3 class="font-semibold text-gray-700 mb-4">Cost Sensitivity</h3>
          <div class="flex gap-2 mb-4" id="cost-buttons"></div>
          <div id="cost-details" class="bg-blue-50 rounded p-4 grid grid-cols-4 gap-4 text-center mb-4"></div>
          <div class="h-64"><canvas id="chart-costs"></canvas></div>
          <p class="text-xs text-gray-500 mt-3 text-center">Default assumption: 10 bps round-trip (5 bps each way). Sector ETF spreads may widen during volatility.</p>
        </div>
      </div>
      
      <!-- Health Tab -->
      <div id="content-health" class="tab-content hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-lg border p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Data Health</h2>
            <div id="health-status" class="rounded-lg p-4 text-center bg-green-50 mb-4">
              <p class="text-sm text-gray-600">Validation</p>
              <p id="health-validation" class="text-2xl font-bold text-green-700">-</p>
            </div>
            <div class="space-y-2">
              <div class="flex justify-between"><span>Signal Date</span><span id="health-date" class="font-mono">-</span></div>
              <div class="flex justify-between"><span>Data Hash</span><span id="health-hash" class="font-mono">-</span></div>
            </div>
          </div>
          <div class="bg-white rounded-lg border p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Parity Check</h2>
            <div class="flex items-center gap-4 mb-4">
              <span id="parity-status" class="px-3 py-1 rounded bg-green-100 text-green-700 font-semibold">-</span>
              <span id="parity-wins" class="text-sm text-gray-600">-</span>
            </div>
            <div id="parity-grid" class="grid grid-cols-2 gap-3"></div>
          </div>
        </div>
        <div class="bg-white rounded-lg border p-6 mt-6">
          <h3 class="font-semibold mb-4">Required Files</h3>
          <div id="files-status" class="grid grid-cols-3 gap-3"></div>
        </div>
      </div>
      
    </main>
    
    <footer class="bg-white border-t mt-8">
      <div class="max-w-7xl mx-auto px-4 py-4 text-center text-xs text-gray-500">
        MV-FRAR Research Dashboard v2.0 | FRAR + Quad System | Cost assumption: 10 bps round-trip | For research purposes only
      </div>
    </footer>
  </div>

<script>
var REQUIRED_FILES = ['manifest.json', 'latest_signal.json', 'metrics.json', 'drivers_timeseries.csv', 'equity_curves.csv', 'cost_sensitivity.json'];
var LINE_COLORS = { SPY_BH: '#3b82f6', '60_40': '#f59e0b', FRAR: '#10b981', FRAR_Net: '#059669' };
var DATA = {};
var CHARTS = {};
var FILE_STATUS = {};

// Quad names mapping
var QUAD_NAMES = {
  1: 'Goldilocks',
  2: 'Reflation',
  3: 'Stagflation',
  4: 'Deflation'
};

var QUAD_FULL_NAMES = {
  1: 'Goldilocks (Growth‚Üë Inflation‚Üì)',
  2: 'Reflation (Growth‚Üë Inflation‚Üë)',
  3: 'Stagflation (Growth‚Üì Inflation‚Üë)',
  4: 'Deflation (Growth‚Üì Inflation‚Üì)'
};

function parseCSV(text) {
  var lines = text.trim().split('\n');
  var headers = lines[0].split(',');
  var result = [];
  for (var i = 1; i < lines.length; i++) {
    var values = lines[i].split(',');
    var row = {};
    for (var j = 0; j < headers.length; j++) {
      var h = headers[j].trim();
      var v = values[j] ? values[j].trim() : '';
      row[h] = v === '' ? null : (isNaN(v) ? v : parseFloat(v));
    }
    result.push(row);
  }
  return result;
}

function loadJSON(file) {
  return fetch('./outputs/' + file + '?v=' + Date.now())
    .then(function(r) {
      if (!r.ok) throw new Error(file + ': HTTP ' + r.status);
      FILE_STATUS[file] = { ok: true };
      return r.json();
    })
    .catch(function(e) {
      FILE_STATUS[file] = { ok: false, error: e.message };
      throw e;
    });
}

function loadCSV(file) {
  return fetch('./outputs/' + file + '?v=' + Date.now())
    .then(function(r) {
      if (!r.ok) throw new Error(file + ': HTTP ' + r.status);
      FILE_STATUS[file] = { ok: true };
      return r.text();
    })
    .then(function(text) {
      return parseCSV(text);
    })
    .catch(function(e) {
      FILE_STATUS[file] = { ok: false, error: e.message };
      throw e;
    });
}

function loadAllData() {
  var errors = [];
  return Promise.all([
    loadJSON('manifest.json').then(function(d) { DATA.manifest = d; }).catch(function(e) { errors.push(e.message); }),
    loadJSON('latest_signal.json').then(function(d) { DATA.signal = d; }).catch(function(e) { errors.push(e.message); }),
    loadJSON('metrics.json').then(function(d) { DATA.metrics = d; }).catch(function(e) { errors.push(e.message); }),
    loadCSV('drivers_timeseries.csv').then(function(d) { DATA.drivers = d; }).catch(function(e) { errors.push(e.message); }),
    loadCSV('equity_curves.csv').then(function(d) { DATA.equity = d; }).catch(function(e) { errors.push(e.message); }),
    loadJSON('cost_sensitivity.json').then(function(d) { DATA.costs = d; }).catch(function(e) { errors.push(e.message); }),
    // Try to load quad signal (optional - won't fail if missing)
    loadJSON('quad_signal.json').then(function(d) { DATA.quad = d; }).catch(function(e) { 
      // Quad signal is optional, create placeholder
      DATA.quad = null;
    })
  ]).then(function() { return errors; });
}

function showTab(name) {
  var contents = document.querySelectorAll('.tab-content');
  for (var i = 0; i < contents.length; i++) contents[i].classList.add('hidden');
  var tabs = document.querySelectorAll('#tabs button');
  for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('tab-active');
  document.getElementById('content-' + name).classList.remove('hidden');
  document.getElementById('tab-' + name).classList.add('tab-active');
}

function formatDate(d) { return d ? d.split('T')[0] : '-'; }
function formatPct(v, dec) { return v != null ? (v * 100).toFixed(dec || 1) + '%' : '-'; }
function formatPctSigned(v, dec) { 
  if (v == null) return '-'; 
  var p = (v * 100).toFixed(dec || 1); 
  return v >= 0 ? '+' + p + '%' : p + '%'; 
}

function renderHeader() {
  var m = DATA.manifest || {};
  var s = DATA.signal || {};
  var q = DATA.quad || {};
  
  document.getElementById('header-version').textContent = m.version || '2.0';
  document.getElementById('header-signal-date').textContent = formatDate(m.latest_signal_date || (q.date));
  
  // FRAR regime
  var reg = s.regime || (q.frar && q.frar.regime) || 'LOW';
  var el = document.getElementById('header-regime');
  el.textContent = reg;
  el.className = 'inline-block px-3 py-1 text-sm font-semibold rounded-full regime-' + reg;
  
  // Quad regime
  var quadNum = (q.quad && q.quad.regime) || 1;
  var quadEl = document.getElementById('header-quad');
  quadEl.textContent = 'Q' + quadNum;
  quadEl.className = 'inline-block px-3 py-1 text-sm font-semibold rounded-full quad-Q' + quadNum;
}

function renderOverview() {
  var s = DATA.signal || {};
  var m = DATA.metrics || {};
  var q = DATA.quad || {};
  var frar = (m.strategies && m.strategies.FRAR_Net) || {};
  var bench = (m.strategies && m.strategies['60_40']) || {};
  
  // FRAR regime
  var reg = s.regime || (q.frar && q.frar.regime) || 'LOW';
  var regDesc = { LOW: 'Full equity (100%)', MID: 'Reduced (80%)', HIGH: 'Minimal (50%)', CRISIS: 'Defensive (20%)' };
  document.getElementById('overview-regime').textContent = reg;
  document.getElementById('overview-regime').className = 'inline-block px-4 py-2 text-lg font-bold rounded-full regime-' + reg;
  document.getElementById('overview-regime-desc').textContent = regDesc[reg] || '-';
  
  // Quad regime
  var quadNum = (q.quad && q.quad.regime) || null;
  if (quadNum) {
    document.getElementById('overview-quad').textContent = 'Q' + quadNum;
    document.getElementById('overview-quad').className = 'inline-block px-4 py-2 text-lg font-bold rounded-full quad-Q' + quadNum;
    document.getElementById('overview-quad-desc').textContent = QUAD_NAMES[quadNum] || '-';
  } else {
    document.getElementById('overview-quad').textContent = '-';
    document.getElementById('overview-quad-desc').textContent = 'No data';
  }
  
  var scalar = s.scalar || (q.frar && q.frar.equity_allocation);
  document.getElementById('overview-scalar').textContent = scalar ? (scalar * 100).toFixed(0) + '%' : '-';
  document.getElementById('overview-date').textContent = formatDate(DATA.manifest && DATA.manifest.latest_signal_date) || formatDate(q.date);
  
  document.getElementById('overview-cagr').textContent = formatPct(frar.cagr, 2);
  document.getElementById('overview-sharpe').textContent = frar.sharpe ? frar.sharpe.toFixed(3) : '-';
  document.getElementById('overview-maxdd').textContent = formatPct(frar.max_dd, 1);
  document.getElementById('overview-calmar').textContent = frar.calmar ? frar.calmar.toFixed(3) : '-';
  
  var cagrD = (frar.cagr || 0) - (bench.cagr || 0);
  var ddD = (bench.max_dd || 0) - (frar.max_dd || 0);
  document.getElementById('overview-vs-cagr').textContent = formatPctSigned(cagrD, 2);
  document.getElementById('overview-vs-cagr').className = 'font-semibold ' + (cagrD >= 0 ? 'text-green-600' : 'text-red-600');
  document.getElementById('overview-vs-dd').textContent = formatPctSigned(ddD, 1);
  document.getElementById('overview-vs-dd').className = 'font-semibold ' + (ddD >= 0 ? 'text-green-600' : 'text-red-600');
  
  var parity = m.parity_check || {};
  document.getElementById('overview-wins').textContent = (parity.parity_wins || 0) + '/4';
  
  renderOverviewChart();
}

function renderOverviewChart() {
  var eq = (DATA.equity || []).filter(function(d) { return d.FRAR_Net != null; }).slice(-252);
  if (eq.length === 0) return;
  var s1 = eq[0].FRAR_Net, s2 = eq[0]['60_40'];
  var norm = eq.map(function(d) { return { date: d.date, FRAR_Net: d.FRAR_Net / s1, b: d['60_40'] / s2 }; });
  var sam = norm.filter(function(d, i) { return i % 5 === 0; });
  if (CHARTS.overview) CHARTS.overview.destroy();
  CHARTS.overview = new Chart(document.getElementById('chart-overview'), {
    type: 'line',
    data: {
      labels: sam.map(function(d) { return d.date; }),
      datasets: [
        { label: 'FRAR Net', data: sam.map(function(d) { return d.FRAR_Net; }), borderColor: '#059669', borderWidth: 2, fill: false, pointRadius: 0 },
        { label: '60/40', data: sam.map(function(d) { return d.b; }), borderColor: '#f59e0b', borderWidth: 2, fill: false, pointRadius: 0 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });
}

function renderQuad() {
  var q = DATA.quad || {};
  var quadData = q.quad || {};
  var frarData = q.frar || {};
  var portfolio = q.portfolio || {};
  var equityPortion = q.equity_portion || {};
  var defensivePortion = q.defensive_portion || {};
  
  var quadNum = quadData.regime || 1;
  
  // Highlight active quad cell
  for (var i = 1; i <= 4; i++) {
    var cell = document.getElementById('quad-cell-' + i);
    if (cell) {
      cell.classList.toggle('active', i === quadNum);
    }
  }
  
  // Regime badge
  var badge = document.getElementById('quad-regime-badge');
  badge.textContent = 'Q' + quadNum;
  badge.className = 'inline-block px-4 py-2 text-lg font-bold rounded-full quad-Q' + quadNum;
  document.getElementById('quad-regime-name').textContent = QUAD_FULL_NAMES[quadNum] || '-';
  
  // Signal details
  var confirmed = quadData.confirmed;
  document.getElementById('quad-confirmed').textContent = confirmed ? 'YES ‚úì' : 'NO (transitional)';
  document.getElementById('quad-confirmed').className = 'text-lg font-bold ' + (confirmed ? 'text-green-600' : 'text-amber-600');
  
  var confidence = quadData.confidence || 'MEDIUM';
  document.getElementById('quad-confidence').textContent = confidence;
  document.getElementById('quad-confidence').className = 'text-lg font-bold confidence-' + confidence;
  
  // Growth signal
  var growthVal = quadData.growth_signal;
  document.getElementById('quad-growth-value').textContent = growthVal != null ? (growthVal >= 0 ? '+' : '') + growthVal.toFixed(4) : '-';
  var growthStrength = quadData.growth_strength || 'MODERATE';
  var growthStrEl = document.getElementById('quad-growth-strength');
  growthStrEl.textContent = growthStrength;
  growthStrEl.className = 'inline-block px-2 py-0.5 text-xs font-semibold rounded mt-1 strength-' + growthStrength;
  
  // Inflation signal
  var inflVal = quadData.inflation_signal;
  document.getElementById('quad-inflation-value').textContent = inflVal != null ? (inflVal >= 0 ? '+' : '') + inflVal.toFixed(4) : '-';
  var inflStrength = quadData.inflation_strength || 'MODERATE';
  var inflStrEl = document.getElementById('quad-inflation-strength');
  inflStrEl.textContent = inflStrength;
  inflStrEl.className = 'inline-block px-2 py-0.5 text-xs font-semibold rounded mt-1 strength-' + inflStrength;
  
  // Warning
  var warningEl = document.getElementById('quad-warning');
  var warningText = document.getElementById('quad-warning-text');
  if (confidence === 'LOW') {
    warningEl.classList.remove('hidden');
    warningText.textContent = 'Weak signals - regime may shift next month';
  } else if (!confirmed) {
    warningEl.classList.remove('hidden');
    warningText.textContent = 'Regime not yet confirmed (need 2 consecutive months)';
  } else {
    warningEl.classList.add('hidden');
  }
  
  // Portfolio allocation
  var summary = q.summary || {};
  var totalEquity = summary.total_equity || 0;
  var totalDefensive = summary.total_defensive || 0;
  
  document.getElementById('quad-equity-pct').textContent = formatPct(totalEquity, 0);
  document.getElementById('quad-defensive-pct').textContent = formatPct(totalDefensive, 0);
  
  // Equity weights
  var equityHtml = '';
  var equitySorted = Object.entries(equityPortion).sort(function(a, b) { return b[1] - a[1]; });
  equitySorted.forEach(function(e) {
    if (e[1] > 0.001) {
      var color = e[0] === 'QQQ' || e[0] === 'SMH' ? 'bg-purple-500' : 'bg-blue-500';
      equityHtml += '<div class="flex items-center gap-2"><span class="w-10 text-xs font-mono">' + e[0] + '</span><div class="flex-1 bg-gray-100 rounded h-4"><div class="h-full rounded ' + color + '" style="width:' + (e[1] * 100) + '%"></div></div><span class="w-12 text-right text-xs font-mono">' + (e[1] * 100).toFixed(1) + '%</span></div>';
    }
  });
  document.getElementById('quad-equity-weights').innerHTML = equityHtml || '<p class="text-gray-500 text-sm">No equity allocation</p>';
  
  // Defensive weights
  var defHtml = '';
  var defSorted = Object.entries(defensivePortion).sort(function(a, b) { return b[1] - a[1]; });
  defSorted.forEach(function(e) {
    if (e[1] > 0.001) {
      defHtml += '<div class="flex items-center gap-2"><span class="w-10 text-xs font-mono">' + e[0] + '</span><div class="flex-1 bg-gray-100 rounded h-4"><div class="h-full rounded bg-amber-500" style="width:' + (e[1] * 100 / (totalDefensive || 1)) + '%"></div></div><span class="w-12 text-right text-xs font-mono">' + (e[1] * 100).toFixed(1) + '%</span></div>';
    }
  });
  document.getElementById('quad-defensive-weights').innerHTML = defHtml || '<p class="text-gray-500 text-sm">No defensive allocation</p>';
}

function renderSignal() {
  var s = DATA.signal || {};
  var q = DATA.quad || {};
  
  document.getElementById('signal-asof').textContent = formatDate(s.as_of_date || q.date);
  document.getElementById('signal-exec').textContent = formatDate(s.execution_date);
  
  var scalar = s.scalar || (q.frar && q.frar.equity_allocation);
  document.getElementById('signal-scalar').textContent = scalar != null ? (scalar * 100).toFixed(0) + '%' : '-';
  
  var reg = s.regime || (q.frar && q.frar.regime) || 'LOW';
  var el = document.getElementById('signal-regime');
  el.textContent = reg;
  el.className = 'inline-block px-3 py-1 text-sm font-semibold rounded-full regime-' + reg;
  
  // Use quad portfolio if available, otherwise fall back to signal weights
  var w = q.portfolio || s.executable_weights || {};
  var entries = Object.entries(w).sort(function(a, b) { return b[1] - a[1]; }).filter(function(e) { return e[1] > 0; });
  var html = '';
  entries.forEach(function(e) {
    html += '<div class="flex items-center gap-2 py-1"><span class="w-12 text-sm font-mono">' + e[0] + '</span><div class="flex-1 bg-gray-100 rounded h-5"><div class="h-full rounded bg-blue-500" style="width:' + (e[1] * 100) + '%"></div></div><span class="w-14 text-right text-sm font-mono">' + (e[1] * 100).toFixed(1) + '%</span></div>';
  });
  document.getElementById('weights-container').innerHTML = html;
}

function renderDrivers() {
  var drv = DATA.drivers || [];
  var lat = drv[drv.length - 1] || {};
  var q = DATA.quad || {};
  var frarData = q.frar || {};
  
  // Use quad data if available, otherwise fall back to drivers
  document.getElementById('current-vol').textContent = (frarData.vol_percentile || lat.vol_percentile) ? (frarData.vol_percentile || lat.vol_percentile).toFixed(3) : '-';
  document.getElementById('current-hill').textContent = (frarData.hill_alpha || lat.hill_alpha) ? (frarData.hill_alpha || lat.hill_alpha).toFixed(2) : '-';
  document.getElementById('current-hurst').textContent = (frarData.hurst_exponent || lat.hurst) ? (frarData.hurst_exponent || lat.hurst).toFixed(3) : '-';
  document.getElementById('current-risk').textContent = (frarData.risk_score || lat.risk_score) ? (frarData.risk_score || lat.risk_score).toFixed(3) : '-';
  document.getElementById('thresh-median').textContent = lat.threshold_median ? lat.threshold_median.toFixed(3) : '-';
  document.getElementById('thresh-75').textContent = lat.threshold_75 ? lat.threshold_75.toFixed(3) : '-';

  // Get threshold values for background shading
  var medianVal = lat.threshold_median || 0.5;
  var p75Val = lat.threshold_75 || 0.75;

  if (CHARTS.drivers) CHARTS.drivers.destroy();
  CHARTS.drivers = new Chart(document.getElementById('chart-drivers'), {
    type: 'line',
    data: {
      labels: drv.map(function(d) { return d.date; }),
      datasets: [
        { label: 'Risk Score', data: drv.map(function(d) { return d.risk_score; }), borderColor: '#1f2937', borderWidth: 2, fill: false, pointRadius: 0, tension: 0.1 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { min: 0, max: 1 } },
      plugins: {
        legend: { position: 'bottom' },
        annotation: {
          annotations: {
            lowZone: { type: 'box', yMin: 0, yMax: medianVal, backgroundColor: 'rgba(34, 197, 94, 0.15)', borderWidth: 0 },
            midZone: { type: 'box', yMin: medianVal, yMax: p75Val, backgroundColor: 'rgba(234, 179, 8, 0.15)', borderWidth: 0 },
            highZone: { type: 'box', yMin: p75Val, yMax: 1, backgroundColor: 'rgba(239, 68, 68, 0.15)', borderWidth: 0 },
            medianLine: { type: 'line', yMin: medianVal, yMax: medianVal, borderColor: '#f97316', borderWidth: 1, borderDash: [5, 5] },
            p75Line: { type: 'line', yMin: p75Val, yMax: p75Val, borderColor: '#dc2626', borderWidth: 1, borderDash: [5, 5] }
          }
        }
      }
    }
  });
}

function renderRegimes() {
  var drv = DATA.drivers || [];
  var recent = drv.slice(-48);
  var colors = { LOW: '#dcfce7', MID: '#fef9c3', HIGH: '#fed7aa', CRISIS: '#fecaca' };
  var txtColors = { LOW: '#166534', MID: '#854d0e', HIGH: '#9a3412', CRISIS: '#991b1b' };
  var html = '';
  recent.forEach(function(d) {
    var st = d.risk_state || 'LOW';
    html += '<div class="w-7 h-7 rounded text-xs font-bold flex items-center justify-center" style="background:' + colors[st] + ';color:' + txtColors[st] + '" title="' + d.date + ': ' + st + '">' + st[0] + '</div>';
  });
  document.getElementById('regime-timeline').innerHTML = html;
  var counts = (DATA.metrics && DATA.metrics.regime_counts) || {};
  var total = 0;
  ['LOW', 'MID', 'HIGH', 'CRISIS'].forEach(function(r) { total += counts[r] || 0; });
  var borders = { LOW: '#22c55e', MID: '#eab308', HIGH: '#f97316', CRISIS: '#ef4444' };
  var distHtml = '';
  ['LOW', 'MID', 'HIGH', 'CRISIS'].forEach(function(r) {
    var c = counts[r] || 0;
    var pct = total > 0 ? ((c / total) * 100).toFixed(0) : 0;
    distHtml += '<div class="flex items-center gap-3 mb-2"><span class="w-16 px-2 py-1 text-xs font-semibold rounded-full regime-' + r + ' text-center">' + r + '</span><div class="flex-1 bg-gray-100 rounded h-4"><div class="h-full rounded" style="width:' + pct + '%;background:' + borders[r] + '"></div></div><span class="text-sm font-mono w-24 text-right">' + c + ' mo (' + pct + '%)</span></div>';
  });
  document.getElementById('regime-distribution').innerHTML = distHtml;
}

function renderVs6040() {
  var m = DATA.metrics || {};
  var frar = (m.strategies && m.strategies.FRAR_Net) || {};
  var bench = (m.strategies && m.strategies['60_40']) || {};
  var metrics = [
    { n: 'CAGR', f: frar.cagr, b: bench.cagr, fmt: function(v) { return formatPct(v, 2); }, hb: true },
    { n: 'Volatility', f: frar.vol, b: bench.vol, fmt: function(v) { return formatPct(v, 1); }, lb: true },
    { n: 'Sharpe', f: frar.sharpe, b: bench.sharpe, fmt: function(v) { return v ? v.toFixed(3) : '-'; }, hb: true },
    { n: 'Max DD', f: frar.max_dd, b: bench.max_dd, fmt: function(v) { return formatPct(v, 1); }, hb: true },
    { n: 'Calmar', f: frar.calmar, b: bench.calmar, fmt: function(v) { return v ? v.toFixed(3) : '-'; }, hb: true }
  ];
  var html = '';
  metrics.forEach(function(x) {
    var diff = (x.f || 0) - (x.b || 0);
    var better = x.lb ? diff < 0 : diff > 0;
    html += '<tr><td class="px-4 py-2 font-medium">' + x.n + '</td><td class="px-4 py-2 text-right font-mono ' + (!better ? 'winner' : '') + '">' + x.fmt(x.b) + '</td><td class="px-4 py-2 text-right font-mono ' + (better ? 'winner' : '') + '">' + x.fmt(x.f) + '</td><td class="px-4 py-2 text-center font-semibold ' + (better ? 'text-green-600' : 'text-amber-600') + '">' + (better ? 'FRAR' : '60/40') + '</td></tr>';
  });
  document.getElementById('vs6040-table').innerHTML = html;
  renderVs6040Chart();
  renderAnnualChart();
}

function renderVs6040Chart() {
  var eq = (DATA.equity || []).filter(function(d) { return d.FRAR_Net != null; });
  var sam = eq.filter(function(d, i) { return i % 10 === 0; });
  if (CHARTS.vs6040) CHARTS.vs6040.destroy();
  CHARTS.vs6040 = new Chart(document.getElementById('chart-vs6040'), {
    type: 'line',
    data: {
      labels: sam.map(function(d) { return d.date; }),
      datasets: [
        { label: '60/40', data: sam.map(function(d) { return d['60_40']; }), borderColor: '#f59e0b', borderWidth: 2, fill: false, pointRadius: 0 },
        { label: 'FRAR Net', data: sam.map(function(d) { return d.FRAR_Net; }), borderColor: '#059669', borderWidth: 2.5, fill: false, pointRadius: 0 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });
}

function renderAnnualChart() {
  var eq = DATA.equity || [];
  var years = {};
  eq.forEach(function(d) {
    var y = d.date ? d.date.slice(0, 4) : null;
    if (!y || !d.FRAR_Net) return;
    if (!years[y]) years[y] = { first: d, last: d };
    years[y].last = d;
  });
  var ann = [];
  Object.keys(years).sort().forEach(function(y) {
    if (y < '2007') return;
    var data = years[y];
    ann.push({ y: y, f: data.last.FRAR_Net / data.first.FRAR_Net - 1, b: data.last['60_40'] / data.first['60_40'] - 1 });
  });
  var wins = ann.filter(function(d) { return d.f > d.b; }).length;
  document.getElementById('annual-summary').textContent = 'FRAR beat 60/40 in ' + wins + '/' + ann.length + ' years';
  if (CHARTS.annual) CHARTS.annual.destroy();
  CHARTS.annual = new Chart(document.getElementById('chart-annual'), {
    type: 'bar',
    data: {
      labels: ann.map(function(d) { return d.y; }),
      datasets: [
        { label: '60/40', data: ann.map(function(d) { return d.b * 100; }), backgroundColor: '#fcd34d' },
        { label: 'FRAR Net', data: ann.map(function(d) { return d.f * 100; }), backgroundColor: '#34d399' }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { ticks: { callback: function(v) { return v + '%'; } } } } }
  });
}

function renderPerformance() {
  var m = DATA.metrics || {};
  var strats = ['SPY_BH', '60_40', 'FRAR', 'FRAR_Net'];
  var html = '';
  strats.forEach(function(n) {
    var s = (m.strategies && m.strategies[n]) || {};
    var isFRAR = n.indexOf('FRAR') >= 0;
    html += '<tr class="' + (isFRAR ? 'bg-green-50' : '') + '"><td class="px-3 py-2 font-medium">' + n + '</td><td class="px-3 py-2 text-right font-mono">' + formatPct(s.cagr, 2) + '</td><td class="px-3 py-2 text-right font-mono">' + formatPct(s.vol, 1) + '</td><td class="px-3 py-2 text-right font-mono">' + (s.sharpe ? s.sharpe.toFixed(3) : '-') + '</td><td class="px-3 py-2 text-right font-mono">' + formatPct(s.max_dd, 1) + '</td><td class="px-3 py-2 text-right font-mono">' + (s.calmar ? s.calmar.toFixed(3) : '-') + '</td></tr>';
  });
  document.getElementById('performance-table').innerHTML = html;
  renderEquityChart(9999);
}

var CURRENT_EQUITY_RANGE = 9999;

function updateEquityRange(months) {
  CURRENT_EQUITY_RANGE = months;
  var btns = document.querySelectorAll('#equity-time-controls .time-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].classList.toggle('active', parseInt(btns[i].dataset.m) === months);
  }
  renderEquityChart(months);
}

function renderEquityChart(months) {
  months = months || 9999;
  var eq = (DATA.equity || []).filter(function(d) { return d.FRAR != null; });
  var cutoff = months < 9999 ? eq.length - (months * 21) : 0;
  if (cutoff < 0) cutoff = 0;
  eq = eq.slice(cutoff);
  var sam = eq.filter(function(d, i) { return i % 5 === 0; });
  if (CHARTS.equity) CHARTS.equity.destroy();
  CHARTS.equity = new Chart(document.getElementById('chart-equity'), {
    type: 'line',
    data: {
      labels: sam.map(function(d) { return d.date; }),
      datasets: [
        { label: 'SPY', data: sam.map(function(d) { return d.SPY_BH; }), borderColor: '#3b82f6', borderWidth: 1.5, fill: false, pointRadius: 0 },
        { label: '60/40', data: sam.map(function(d) { return d['60_40']; }), borderColor: '#f59e0b', borderWidth: 1.5, fill: false, pointRadius: 0 },
        { label: 'FRAR', data: sam.map(function(d) { return d.FRAR; }), borderColor: '#10b981', borderWidth: 2.5, fill: false, pointRadius: 0 },
        { label: 'FRAR Net', data: sam.map(function(d) { return d.FRAR_Net; }), borderColor: '#059669', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });
}

function renderCosts() {
  var t = (DATA.metrics && DATA.metrics.turnovers) || {};
  
  // Get FRAR total turnover to calculate decomposition
  var frarTotal = t.FRAR ? t.FRAR.annualized : 4.74;
  var sectorBaseline = t.Ungated_Sectors ? t.Ungated_Sectors.annualized : 3.26;
  
  // Risk signal turnover = total - sector sleeve contribution
  // Sector sleeve ‚âà baseline sector turnover, Risk signal = remainder
  var riskSignalTurnover = Math.max(0.3, frarTotal - sectorBaseline).toFixed(2);
  var sectorSleeveTurnover = sectorBaseline.toFixed(2);
  
  var html = '';
  
  // Benchmarks section
  html += '<tr class="bg-gray-50"><td colspan="4" class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase">Benchmarks</td></tr>';
  
  if (t.SPY_BH) {
    html += '<tr><td class="px-3 py-2 font-medium">SPY Buy & Hold</td><td class="px-3 py-2 text-right font-mono">0.00x</td><td class="px-3 py-2 text-right font-mono">0.0 bps</td><td class="px-3 py-2 text-sm text-gray-500">No rebalancing</td></tr>';
  }
  if (t['60_40']) {
    html += '<tr><td class="px-3 py-2 font-medium">60/40 Portfolio</td><td class="px-3 py-2 text-right font-mono">' + t['60_40'].annualized.toFixed(2) + 'x</td><td class="px-3 py-2 text-right font-mono">' + t['60_40'].cost_drag_bps.toFixed(1) + ' bps</td><td class="px-3 py-2 text-sm text-gray-500">Monthly rebalance to target</td></tr>';
  }
  if (t.Ungated_Sectors) {
    html += '<tr><td class="px-3 py-2 font-medium">Sector Baseline</td><td class="px-3 py-2 text-right font-mono">' + t.Ungated_Sectors.annualized.toFixed(2) + 'x</td><td class="px-3 py-2 text-right font-mono">' + t.Ungated_Sectors.cost_drag_bps.toFixed(1) + ' bps</td><td class="px-3 py-2 text-sm text-gray-500">MV optimization without risk overlay</td></tr>';
  }
  
  // FRAR decomposition section
  html += '<tr class="bg-gray-50 border-t"><td colspan="4" class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase">FRAR Decomposition</td></tr>';
  
  // Risk Signal row (the important one - shows signal is stable)
  html += '<tr class="bg-blue-50"><td class="px-3 py-2 font-medium">‚îî Risk Signal</td><td class="px-3 py-2 text-right font-mono font-semibold text-blue-700">' + riskSignalTurnover + 'x</td><td class="px-3 py-2 text-right font-mono">' + (riskSignalTurnover * 10).toFixed(1) + ' bps</td><td class="px-3 py-2 text-sm text-blue-600">Regime changes only (~4-6/year)</td></tr>';
  
  // Sector Sleeve row
  html += '<tr><td class="px-3 py-2 font-medium">‚îî Sector Sleeve</td><td class="px-3 py-2 text-right font-mono">' + sectorSleeveTurnover + 'x</td><td class="px-3 py-2 text-right font-mono">' + (sectorSleeveTurnover * 10).toFixed(1) + ' bps</td><td class="px-3 py-2 text-sm text-gray-500">Monthly MV rebalancing</td></tr>';
  
  // FRAR Total row
  if (t.FRAR) {
    html += '<tr class="bg-green-50 border-t"><td class="px-3 py-2 font-semibold">FRAR Total</td><td class="px-3 py-2 text-right font-mono font-semibold">' + t.FRAR.annualized.toFixed(2) + 'x</td><td class="px-3 py-2 text-right font-mono font-semibold">' + t.FRAR.cost_drag_bps.toFixed(1) + ' bps</td><td class="px-3 py-2 text-sm text-gray-500">Risk Signal + Sector Sleeve</td></tr>';
  }
  
  document.getElementById('turnover-table').innerHTML = html;
  
  var c = DATA.costs || {};
  var lvls = c.cost_levels_bps || [];
  var rows = c.rows || [];
  var btnHtml = '';
  lvls.forEach(function(l) {
    var isActive = l === 10;
    btnHtml += '<button onclick="selectCost(' + l + ')" id="cost-btn-' + l + '" class="px-3 py-1 rounded text-sm font-mono ' + (isActive ? 'bg-blue-600 text-white' : 'bg-gray-100') + '">' + l + ' bps</button>';
  });
  document.getElementById('cost-buttons').innerHTML = btnHtml;
  selectCost(10);
  if (CHARTS.costs) CHARTS.costs.destroy();
  CHARTS.costs = new Chart(document.getElementById('chart-costs'), {
    type: 'bar',
    data: {
      labels: rows.map(function(r) { return r.cost_bps + ' bps'; }),
      datasets: [{ label: 'CAGR', data: rows.map(function(r) { return r.cagr * 100; }), backgroundColor: '#93c5fd' }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: function(v) { return v.toFixed(1) + '%'; } } } } }
  });
}

function selectCost(cost) {
  var btns = document.querySelectorAll('#cost-buttons button');
  for (var i = 0; i < btns.length; i++) {
    btns[i].className = btns[i].id === 'cost-btn-' + cost ? 'px-3 py-1 rounded text-sm font-mono bg-blue-600 text-white' : 'px-3 py-1 rounded text-sm font-mono bg-gray-100';
  }
  var rows = (DATA.costs && DATA.costs.rows) || [];
  var r = rows.find(function(x) { return x.cost_bps === cost; });
  if (r) {
    document.getElementById('cost-details').innerHTML = '<div><p class="text-xs text-gray-500">CAGR</p><p class="text-lg font-semibold">' + formatPct(r.cagr, 2) + '</p></div><div><p class="text-xs text-gray-500">Sharpe</p><p class="text-lg font-semibold">' + (r.sharpe ? r.sharpe.toFixed(3) : '-') + '</p></div><div><p class="text-xs text-gray-500">Max DD</p><p class="text-lg font-semibold">' + formatPct(r.max_dd, 1) + '</p></div><div><p class="text-xs text-gray-500">Calmar</p><p class="text-lg font-semibold">' + (r.calmar ? r.calmar.toFixed(3) : '-') + '</p></div>';
  }
}

function renderHealth() {
  var m = DATA.manifest || {};
  var v = (DATA.metrics && DATA.metrics.validation) || {};
  var p = (DATA.metrics && DATA.metrics.parity_check) || {};
  document.getElementById('health-validation').textContent = v.status || '?';
  document.getElementById('health-validation').className = 'text-2xl font-bold ' + (v.status === 'PASS' ? 'text-green-700' : 'text-red-700');
  document.getElementById('health-date').textContent = formatDate(m.latest_signal_date);
  document.getElementById('health-hash').textContent = m.data_hash ? m.data_hash.slice(0, 12) : '-';
  document.getElementById('parity-status').textContent = p.parity_status || '?';
  document.getElementById('parity-wins').textContent = 'FRAR wins ' + (p.parity_wins || 0) + '/4';
  var comps = p.parity_components || {};
  var gridHtml = '';
  Object.keys(comps).forEach(function(k) {
    var x = comps[k];
    gridHtml += '<div class="rounded-lg p-3 ' + (x.frar_wins ? 'bg-green-50' : 'bg-amber-50') + '"><p class="text-xs text-gray-500 uppercase">' + k.replace('_', ' ') + '</p><p class="text-sm font-semibold">' + (x.frar_wins ? '‚úì FRAR' : '‚úó 60/40') + '</p></div>';
  });
  document.getElementById('parity-grid').innerHTML = gridHtml;
  var filesHtml = '';
  REQUIRED_FILES.forEach(function(f) {
    var ok = FILE_STATUS[f] && FILE_STATUS[f].ok;
    filesHtml += '<div class="flex items-center gap-2 p-2 rounded ' + (ok ? 'bg-green-50' : 'bg-red-50') + '"><span class="' + (ok ? 'text-green-600' : 'text-red-600') + '">' + (ok ? '‚úì' : '‚úó') + '</span><span class="text-sm font-mono">' + f + '</span></div>';
  });
  document.getElementById('files-status').innerHTML = filesHtml;
}

function init() {
  loadAllData().then(function(errors) {
    document.getElementById('loading').classList.add('hidden');
    if (errors.length > 0 && Object.keys(DATA).length < 3) {
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-details').innerHTML = errors.map(function(e) { return '‚Ä¢ ' + e; }).join('<br>');
      return;
    }
    document.getElementById('app').classList.remove('hidden');
    renderHeader();
    renderOverview();
    renderQuad();
    renderSignal();
    renderDrivers();
    renderRegimes();
    renderVs6040();
    renderPerformance();
    renderCosts();
    renderHealth();
  }).catch(function(e) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('error').classList.remove('hidden');
    document.getElementById('error-details').textContent = 'Unexpected error: ' + e.message;
  });
}

init();
</script>
</body>
</html>
