<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MV-FRAR Research Dashboard</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar, ComposedChart, Area, Cell } = Recharts;

    // ============================================================================
    // CONFIG - Update this for your deployment
    // ============================================================================
    const OUTPUTS_BASE_URL = './outputs';

    // ============================================================================
    // DATA LOADING
    // ============================================================================
    async function loadJSON(filename) {
      const response = await fetch(`${OUTPUTS_BASE_URL}/${filename}`);
      if (!response.ok) throw new Error(`Failed to load ${filename}`);
      return response.json();
    }

    async function loadCSV(filename) {
      const response = await fetch(`${OUTPUTS_BASE_URL}/${filename}`);
      if (!response.ok) throw new Error(`Failed to load ${filename}`);
      const text = await response.text();
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = line.split(',');
        const row = {};
        headers.forEach((h, i) => {
          const v = values[i];
          row[h.trim()] = v === '' ? null : (isNaN(v) ? v : parseFloat(v));
        });
        return row;
      });
    }

    // ============================================================================
    // THEME
    // ============================================================================
    const REGIME_COLORS = {
      LOW: { bg: '#dcfce7', text: '#166534', border: '#22c55e' },
      MID: { bg: '#fef9c3', text: '#854d0e', border: '#eab308' },
      HIGH: { bg: '#fed7aa', text: '#9a3412', border: '#f97316' },
      CRISIS: { bg: '#fecaca', text: '#991b1b', border: '#ef4444' }
    };

    const CHART_COLORS = {
      SPY_BH: '#4A90D9', '60_40': '#F5A623', FRAR: '#2ECC71', FRAR_Net: '#27ae60',
      risk_score: '#e74c3c', vol_percentile: '#3498db', hurst: '#1abc9c'
    };

    // ============================================================================
    // COMPONENTS
    // ============================================================================
    const RegimeBadge = ({ regime, size = 'normal' }) => {
      const colors = REGIME_COLORS[regime] || REGIME_COLORS.LOW;
      const sizeClasses = size === 'small' ? 'px-2 py-0.5 text-xs' : 'px-3 py-1 text-sm';
      return (
        <span className={`inline-flex items-center rounded-full font-semibold ${sizeClasses}`}
          style={{ backgroundColor: colors.bg, color: colors.text, border: `2px solid ${colors.border}` }}>
          {regime}
        </span>
      );
    };

    const StatusBadge = ({ status, size = 'normal' }) => {
      const colors = { PASS: { bg: '#dcfce7', text: '#166534' }, FAIL: { bg: '#fecaca', text: '#991b1b' } };
      const c = colors[status] || { bg: '#f3f4f6', text: '#6b7280' };
      const sizeClasses = size === 'small' ? 'px-2 py-0.5 text-xs' : 'px-3 py-1 text-sm';
      return <span className={`inline-flex items-center rounded font-semibold ${sizeClasses}`} style={{ backgroundColor: c.bg, color: c.text }}>{status}</span>;
    };

    const WeightBar = ({ ticker, weight, isDefensive = false }) => {
      const pct = (weight * 100).toFixed(1);
      const barColor = isDefensive ? '#f59e0b' : '#3b82f6';
      return (
        <div className="flex items-center gap-2 py-1">
          <span className="w-12 text-sm font-mono text-gray-600">{ticker}</span>
          <div className="flex-1 bg-gray-100 rounded h-5 overflow-hidden">
            <div className="h-full rounded" style={{ width: `${Math.max(weight * 100, 0)}%`, backgroundColor: weight > 0 ? barColor : '#e5e7eb' }} />
          </div>
          <span className="w-14 text-right text-sm font-mono">{pct}%</span>
        </div>
      );
    };

    const LoadingSpinner = () => (
      <div className="flex items-center justify-center p-12">
        <div className="loading-spinner rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <span className="ml-3 text-gray-600">Loading data...</span>
      </div>
    );

    const ErrorCard = ({ errors }) => (
      <div className="max-w-2xl mx-auto mt-12 bg-red-50 border border-red-200 rounded-lg p-6">
        <h2 className="text-xl font-bold text-red-800 mb-4">‚ö†Ô∏è Data Loading Failed</h2>
        <p className="text-red-700 mb-4">Required data files are missing or invalid.</p>
        <div className="bg-white rounded p-4 border border-red-200">
          <p className="font-semibold text-gray-700 mb-2">Missing files:</p>
          <ul className="list-disc list-inside text-red-600 font-mono text-sm">
            {errors.map((e, i) => <li key={i}>{e}</li>)}
          </ul>
        </div>
      </div>
    );

    // ============================================================================
    // HEADER
    // ============================================================================
    const Header = ({ manifest, signal, metrics, onHealthClick }) => {
      const validation = metrics?.validation || { status: 'UNKNOWN' };
      return (
        <header className="bg-white border-b">
          <div className="max-w-6xl mx-auto px-4 py-4">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div>
                <h1 className="text-2xl font-bold text-gray-800">MV-FRAR Research Dashboard</h1>
                <p className="text-sm text-gray-500">Version {manifest?.version || '?'}</p>
              </div>
              <button onClick={onHealthClick} className="flex items-center gap-4 bg-gray-50 hover:bg-gray-100 rounded-lg px-4 py-2">
                <div className="text-right">
                  <p className="text-xs text-gray-500">Status</p>
                  <StatusBadge status={validation.status} size="small" />
                </div>
                <div className="text-right">
                  <p className="text-xs text-gray-500">Signal</p>
                  <p className="text-sm font-mono">{manifest?.latest_signal_date || '?'}</p>
                </div>
                <div className="text-right">
                  <p className="text-xs text-gray-500">Hash</p>
                  <p className="text-xs font-mono text-gray-600">{manifest?.data_hash?.slice(0, 8) || '?'}</p>
                </div>
                <RegimeBadge regime={signal?.regime || 'LOW'} size="small" />
              </button>
            </div>
          </div>
        </header>
      );
    };

    // ============================================================================
    // TABS
    // ============================================================================
    const SignalTab = ({ signal }) => {
      const [showModel, setShowModel] = useState(false);
      const isDefensive = signal.regime === 'HIGH' || signal.regime === 'CRISIS';
      const defensiveAssets = ['TLT', 'IEF', 'GLD'];
      const sectorWeights = Object.entries(signal.executable_weights || {}).filter(([t]) => !defensiveAssets.includes(t)).sort((a,b) => b[1]-a[1]).filter(([,w]) => w > 0);
      const defWeights = Object.entries(signal.executable_weights || {}).filter(([t]) => defensiveAssets.includes(t)).filter(([,w]) => w > 0);

      return (
        <div className="bg-white rounded-lg border p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Current Signal</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div><p className="text-sm text-gray-500">As-Of Date</p><p className="text-lg font-semibold">{signal.as_of_date}</p></div>
            <div><p className="text-sm text-gray-500">Execution Date</p><p className="text-lg font-semibold">{signal.execution_date}</p></div>
            <div><p className="text-sm text-gray-500">Regime</p><div className="mt-1"><RegimeBadge regime={signal.regime} /></div></div>
            <div><p className="text-sm text-gray-500">Equity Scalar</p><p className="text-lg font-semibold">{(signal.scalar * 100).toFixed(0)}%</p></div>
          </div>
          
          {isDefensive && (
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
              <p className="font-semibold text-orange-800">‚ö†Ô∏è Equity sleeve disabled ‚Äî Defensive basket active</p>
            </div>
          )}
          
          <div className="border-t pt-4">
            <h3 className="font-semibold text-gray-700 mb-3">Model Output Allocation</h3>
            {isDefensive && defWeights.length > 0 && (
              <div className="mb-4 max-w-md bg-orange-50 p-3 rounded">
                <p className="text-sm text-gray-500 mb-2">Defensive Basket</p>
                {defWeights.map(([t,w]) => <WeightBar key={t} ticker={t} weight={w} isDefensive />)}
              </div>
            )}
            <div className="max-w-md">
              {sectorWeights.map(([t,w]) => <WeightBar key={t} ticker={t} weight={w} />)}
            </div>
          </div>
          
          <div className="border-t pt-4 mt-4 bg-blue-50 rounded p-3">
            <p className="text-sm text-blue-800"><strong>System:</strong> FRAR provides risk regime. Sector weights are the MV-FRAR demonstration sleeve.</p>
          </div>
          
          <div className="mt-4 bg-gray-50 border rounded p-3 text-sm text-gray-700">
            <strong>Note:</strong> Equity exposure is 0% in HIGH/CRISIS regimes.
          </div>
        </div>
      );
    };

    const RiskDriversTab = ({ driversData }) => {
      const recent = driversData.slice(-60);
      return (
        <div className="bg-white rounded-lg border p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Risk Drivers</h2>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <ComposedChart data={recent}>
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis dataKey="date" tick={{ fontSize: 10 }} interval={5} />
                <YAxis tick={{ fontSize: 11 }} domain={[0, 1]} />
                <Tooltip formatter={(v) => v?.toFixed(3)} />
                <Legend />
                <Area type="monotone" dataKey="risk_score" fill="#fee2e2" stroke="#ef4444" strokeWidth={2} name="Risk Score" />
                <Line type="monotone" dataKey="threshold_median" stroke="#f97316" strokeDasharray="5 5" dot={false} name="Median" />
                <Line type="monotone" dataKey="threshold_75" stroke="#dc2626" strokeDasharray="5 5" dot={false} name="75th" />
              </ComposedChart>
            </ResponsiveContainer>
          </div>
          <div className="mt-4 bg-gray-50 rounded p-3 text-sm">
            <strong>Formula:</strong> <code>risk_score = 0.5√óvol + 0.3√óhill + 0.2√ó(1-hurst)</code>
          </div>
        </div>
      );
    };

    const RegimeTab = ({ driversData, metrics }) => {
      const counts = metrics.regime_counts || {};
      const total = Object.values(counts).reduce((a,b) => a+b, 0);
      const recent = driversData.slice(-48);
      return (
        <div className="bg-white rounded-lg border p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Regime History</h2>
          <div className="flex gap-1 flex-wrap mb-6">
            {recent.map((d, i) => (
              <div key={i} className="w-6 h-6 rounded text-xs font-bold flex items-center justify-center"
                style={{ backgroundColor: REGIME_COLORS[d.risk_state]?.bg, color: REGIME_COLORS[d.risk_state]?.text }}
                title={`${d.date}: ${d.risk_state}`}>
                {d.risk_state?.[0]}
              </div>
            ))}
          </div>
          <div className="border-t pt-4">
            {['LOW','MID','HIGH','CRISIS'].map(r => (
              <div key={r} className="flex items-center gap-3 mb-2">
                <RegimeBadge regime={r} />
                <div className="flex-1 bg-gray-100 rounded h-4 overflow-hidden">
                  <div className="h-full rounded" style={{ width: `${((counts[r]||0)/total)*100}%`, backgroundColor: REGIME_COLORS[r]?.border }} />
                </div>
                <span className="text-sm font-mono w-24 text-right">{counts[r]||0} ({(((counts[r]||0)/total)*100).toFixed(0)}%)</span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    const PerformanceTab = ({ metrics, equityData }) => {
      const strategies = ['SPY_BH', '60_40', 'FRAR', 'FRAR_Net'];
      const recent = equityData.filter(d => d.FRAR != null).slice(-250);
      return (
        <div className="space-y-6">
          <div className="bg-white rounded-lg border p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Performance</h2>
            <table className="w-full text-sm">
              <thead><tr className="bg-gray-50">
                <th className="px-3 py-2 text-left">Strategy</th>
                <th className="px-3 py-2 text-right">CAGR</th>
                <th className="px-3 py-2 text-right">Sharpe</th>
                <th className="px-3 py-2 text-right">MaxDD</th>
              </tr></thead>
              <tbody>
                {strategies.map(n => {
                  const m = metrics.strategies?.[n];
                  if (!m) return null;
                  return (
                    <tr key={n} className={n.includes('FRAR') ? 'bg-green-50' : ''}>
                      <td className="px-3 py-2">{n}</td>
                      <td className="px-3 py-2 text-right font-mono">{(m.cagr*100).toFixed(2)}%</td>
                      <td className="px-3 py-2 text-right font-mono">{m.sharpe?.toFixed(3)}</td>
                      <td className="px-3 py-2 text-right font-mono">{(m.max_dd*100).toFixed(1)}%</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          <div className="bg-white rounded-lg border p-6">
            <h3 className="font-semibold text-gray-700 mb-4">Equity Curves</h3>
            <div className="h-64">
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={recent}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="date" tick={{ fontSize: 10 }} interval={50} />
                  <YAxis tick={{ fontSize: 11 }} />
                  <Tooltip />
                  <Legend />
                  <Line type="monotone" dataKey="SPY_BH" stroke={CHART_COLORS.SPY_BH} dot={false} name="SPY" />
                  <Line type="monotone" dataKey="FRAR" stroke={CHART_COLORS.FRAR} dot={false} strokeWidth={2} name="FRAR (gross)" />
                  <Line type="monotone" dataKey="FRAR_Net" stroke={CHART_COLORS.FRAR_Net} dot={false} strokeDasharray="5 5" name="FRAR (net)" />
                </LineChart>
              </ResponsiveContainer>
            </div>
          </div>
        </div>
      );
    };

    const TurnoverTab = ({ metrics, costSensitivity }) => {
      const [cost, setCost] = useState(10);
      const row = costSensitivity?.rows?.find(r => r.cost_bps === cost);
      return (
        <div className="space-y-6">
          <div className="bg-white rounded-lg border p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Turnover & Costs</h2>
            <table className="w-full text-sm">
              <thead><tr className="bg-gray-50">
                <th className="px-3 py-2 text-left">Strategy</th>
                <th className="px-3 py-2 text-right">Turnover</th>
                <th className="px-3 py-2 text-right">Cost</th>
              </tr></thead>
              <tbody>
                {Object.entries(metrics.turnovers || {}).map(([n, t]) => (
                  <tr key={n} className={n === 'FRAR' ? 'bg-green-50' : ''}>
                    <td className="px-3 py-2">{n}</td>
                    <td className="px-3 py-2 text-right font-mono">{t.annualized?.toFixed(2)}x</td>
                    <td className="px-3 py-2 text-right font-mono">{t.cost_drag_bps?.toFixed(1)} bps</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div className="bg-white rounded-lg border p-6">
            <h3 className="font-semibold text-gray-700 mb-4">Cost Sensitivity</h3>
            <div className="flex gap-2 mb-4 flex-wrap">
              {(costSensitivity?.cost_levels_bps || []).map(c => (
                <button key={c} onClick={() => setCost(c)} className={`px-3 py-1 rounded text-sm font-mono ${cost === c ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>{c}bps</button>
              ))}
            </div>
            {row && (
              <div className="bg-blue-50 rounded p-4 grid grid-cols-4 gap-4 text-center">
                <div><p className="text-xs text-gray-500">CAGR</p><p className="font-semibold">{(row.cagr*100).toFixed(2)}%</p></div>
                <div><p className="text-xs text-gray-500">Sharpe</p><p className="font-semibold">{row.sharpe?.toFixed(3)}</p></div>
                <div><p className="text-xs text-gray-500">MaxDD</p><p className="font-semibold">{(row.max_dd*100).toFixed(1)}%</p></div>
                <div><p className="text-xs text-gray-500">Calmar</p><p className="font-semibold">{row.calmar?.toFixed(3)}</p></div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const HealthTab = ({ metrics, manifest }) => {
      const parity = metrics.parity_check || {};
      const validation = metrics.validation || { status: 'UNKNOWN', warnings: [] };
      return (
        <div className="bg-white rounded-lg border p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Data Health</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div className={`rounded-lg p-4 text-center ${validation.status === 'PASS' ? 'bg-green-50' : 'bg-red-50'}`}>
              <p className="text-sm text-gray-600">Validation</p>
              <p className={`text-2xl font-bold ${validation.status === 'PASS' ? 'text-green-700' : 'text-red-700'}`}>{validation.status}</p>
            </div>
            <div className="bg-gray-50 rounded-lg p-4 text-center">
              <p className="text-sm text-gray-600">Version</p>
              <p className="text-lg font-mono">{manifest?.version}</p>
            </div>
            <div className="bg-gray-50 rounded-lg p-4 text-center">
              <p className="text-sm text-gray-600">Data Hash</p>
              <p className="text-sm font-mono">{manifest?.data_hash?.slice(0,12)}</p>
            </div>
            <div className="bg-gray-50 rounded-lg p-4 text-center">
              <p className="text-sm text-gray-600">Signal Date</p>
              <p className="text-sm font-mono">{manifest?.latest_signal_date}</p>
            </div>
          </div>
          
          <div className="border-t pt-4">
            <h3 className="font-semibold text-gray-700 mb-3">Parity Check vs 60/40</h3>
            <div className="flex items-center gap-4 mb-4">
              <StatusBadge status={parity.parity_status || 'N/A'} />
              <span className="text-sm">FRAR wins {parity.parity_wins || 0}/4</span>
            </div>
            {parity.parity_components && (
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                {Object.entries(parity.parity_components).map(([m, d]) => (
                  <div key={m} className={`rounded-lg p-3 ${d.frar_wins ? 'bg-green-50' : 'bg-red-50'}`}>
                    <p className="text-xs text-gray-500 uppercase">{m}</p>
                    <p className="font-mono text-sm">{d.frar_wins ? '‚úì' : '‚úó'}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
          
          <div className="border-t pt-4 mt-4">
            <h3 className="font-semibold text-gray-700 mb-3">Downloads</h3>
            <div className="flex gap-2 flex-wrap">
              <a href={`${OUTPUTS_BASE_URL}/latest_signal.json`} download className="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm">üìÑ Signal</a>
              <a href={`${OUTPUTS_BASE_URL}/audit.csv`} download className="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm">üìä Audit</a>
              <a href={`${OUTPUTS_BASE_URL}/tearsheet.pdf`} download className="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm">üìë PDF</a>
            </div>
          </div>
        </div>
      );
    };

    const DisclosurePanel = () => (
      <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 text-xs text-amber-800 mb-6">
        <p className="font-semibold mb-1">‚ö†Ô∏è Research System Disclosures</p>
        <ul className="list-disc list-inside">
          <li>Research system, not trading advice</li>
          <li>Monthly rebalance, T+1 execution</li>
          <li>Past performance ‚â† future results</li>
        </ul>
      </div>
    );

    // ============================================================================
    // MAIN APP
    // ============================================================================
    function App() {
      const [tab, setTab] = useState('signal');
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [data, setData] = useState({});

      useEffect(() => {
        async function load() {
          const errors = [];
          const d = {};
          
          try { d.manifest = await loadJSON('manifest.json'); } catch { errors.push('manifest.json'); }
          try { d.signal = await loadJSON('latest_signal.json'); } catch { errors.push('latest_signal.json'); }
          try { d.metrics = await loadJSON('metrics.json'); } catch { errors.push('metrics.json'); }
          try { d.equityData = await loadCSV('equity_curves.csv'); } catch { errors.push('equity_curves.csv'); }
          try { d.driversData = await loadCSV('drivers_timeseries.csv'); } catch { errors.push('drivers_timeseries.csv'); }
          try { d.costSensitivity = await loadJSON('cost_sensitivity.json'); } catch { errors.push('cost_sensitivity.json'); }
          
          if (errors.length > 0) setError(errors);
          else setData(d);
          setLoading(false);
        }
        load();
      }, []);

      const tabs = [
        { id: 'signal', label: 'Signal' },
        { id: 'drivers', label: 'Risk Drivers' },
        { id: 'regime', label: 'Regimes' },
        { id: 'performance', label: 'Performance' },
        { id: 'turnover', label: 'Costs' },
        { id: 'health', label: 'Health' }
      ];

      if (loading) return <LoadingSpinner />;
      if (error) return <ErrorCard errors={error} />;

      const { manifest, signal, metrics, equityData, driversData, costSensitivity } = data;

      return (
        <div className="min-h-screen bg-gray-50">
          <Header manifest={manifest} signal={signal} metrics={metrics} onHealthClick={() => setTab('health')} />
          
          <nav className="bg-white border-b">
            <div className="max-w-6xl mx-auto px-4">
              <div className="flex gap-1 overflow-x-auto">
                {tabs.map(t => (
                  <button key={t.id} onClick={() => setTab(t.id)}
                    className={`px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap ${tab === t.id ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500'}`}>
                    {t.label}
                  </button>
                ))}
              </div>
            </div>
          </nav>
          
          <main className="max-w-6xl mx-auto px-4 py-6">
            <DisclosurePanel />
            {tab === 'signal' && <SignalTab signal={signal} />}
            {tab === 'drivers' && <RiskDriversTab driversData={driversData} />}
            {tab === 'regime' && <RegimeTab driversData={driversData} metrics={metrics} />}
            {tab === 'performance' && <PerformanceTab metrics={metrics} equityData={equityData} />}
            {tab === 'turnover' && <TurnoverTab metrics={metrics} costSensitivity={costSensitivity} />}
            {tab === 'health' && <HealthTab metrics={metrics} manifest={manifest} />}
          </main>
          
          <footer className="bg-white border-t mt-8">
            <div className="max-w-6xl mx-auto px-4 py-4 text-center text-xs text-gray-500">
              MV-FRAR Research Dashboard v1.1 ‚Ä¢ For research purposes only
            </div>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
