<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MV-FRAR Research Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    .regime-LOW { background: #dcfce7; color: #166534; border: 2px solid #22c55e; }
    .regime-MID { background: #fef9c3; color: #854d0e; border: 2px solid #eab308; }
    .regime-HIGH { background: #fed7aa; color: #9a3412; border: 2px solid #f97316; }
    .regime-CRISIS { background: #fecaca; color: #991b1b; border: 2px solid #ef4444; }
    .time-btn { transition: all 0.15s; }
    .time-btn:hover { background: #e5e7eb; }
    .time-btn.active { background: #3b82f6; color: white; }
    .winner { background: #dcfce7; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  
  <div id="loading" class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <div class="text-4xl mb-4">ðŸ“Š</div>
      <p class="text-gray-600">Loading dashboard data...</p>
    </div>
  </div>
  
  <div id="error" class="hidden max-w-2xl mx-auto mt-12 bg-red-50 border border-red-200 rounded-lg p-6">
    <h2 class="text-xl font-bold text-red-800 mb-4">Data Loading Failed</h2>
    <div id="error-details" class="bg-white rounded p-4 border border-red-200 font-mono text-sm text-red-600"></div>
  </div>
  
  <div id="app" class="hidden">
    <header class="bg-white border-b shadow-sm">
      <div class="max-w-7xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">MV-FRAR Research Dashboard</h1>
            <p class="text-sm text-gray-500">Version <span id="header-version">-</span></p>
          </div>
          <div class="flex items-center gap-6">
            <div class="text-right text-xs">
              <p class="text-gray-400">Signal Date</p>
              <p id="header-signal-date" class="font-mono font-semibold">-</p>
            </div>
            <div>
              <span id="header-regime" class="inline-block px-3 py-1 text-sm font-semibold rounded-full regime-LOW">-</span>
            </div>
          </div>
        </div>
      </div>
    </header>
    
    <nav class="bg-white border-b sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex gap-1 overflow-x-auto" id="tabs">
          <button onclick="showTab('overview')" id="tab-overview" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700 tab-active">Overview</button>
          <button onclick="showTab('signal')" id="tab-signal" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Signal</button>
          <button onclick="showTab('drivers')" id="tab-drivers" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Risk Drivers</button>
          <button onclick="showTab('regime')" id="tab-regime" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Regimes</button>
          <button onclick="showTab('vs6040')" id="tab-vs6040" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">vs 60/40</button>
          <button onclick="showTab('performance')" id="tab-performance" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Performance</button>
          <button onclick="showTab('costs')" id="tab-costs" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Costs</button>
          <button onclick="showTab('health')" id="tab-health" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-700">Health</button>
        </div>
      </div>
    </nav>
    
    <main class="max-w-7xl mx-auto px-4 py-6">
      
      <!-- Overview Tab -->
      <div id="content-overview" class="tab-content">
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <div class="bg-white rounded-lg border p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Current Status</h3>
            <div class="flex items-center gap-4 mb-4">
              <span id="overview-regime" class="inline-block px-4 py-2 text-lg font-bold rounded-full regime-LOW">-</span>
              <div>
                <p class="text-sm text-gray-500">Risk Regime</p>
                <p id="overview-regime-desc" class="text-sm font-medium">-</p>
              </div>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between"><span class="text-gray-500">Equity Exposure</span><span id="overview-scalar" class="font-semibold">-</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Signal Date</span><span id="overview-date" class="font-mono">-</span></div>
            </div>
          </div>
          <div class="bg-white rounded-lg border p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">FRAR Net Performance</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center p-3 bg-gray-50 rounded"><p class="text-2xl font-bold" id="overview-cagr">-</p><p class="text-xs text-gray-500">CAGR</p></div>
              <div class="text-center p-3 bg-gray-50 rounded"><p class="text-2xl font-bold" id="overview-sharpe">-</p><p class="text-xs text-gray-500">Sharpe</p></div>
              <div class="text-center p-3 bg-gray-50 rounded"><p class="text-2xl font-bold" id="overview-maxdd">-</p><p class="text-xs text-gray-500">Max DD</p></div>
              <div class="text-center p-3 bg-gray-50 rounded"><p class="text-2xl font-bold" id="overview-calmar">-</p><p class="text-xs text-gray-500">Calmar</p></div>
            </div>
          </div>
          <div class="bg-white rounded-lg border p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">vs 60/40 Benchmark</h3>
            <div class="space-y-3">
              <div class="flex justify-between"><span class="text-gray-600">CAGR Advantage</span><span id="overview-vs-cagr" class="font-semibold">-</span></div>
              <div class="flex justify-between"><span class="text-gray-600">Max DD Improvement</span><span id="overview-vs-dd" class="font-semibold">-</span></div>
              <div class="flex justify-between"><span class="text-gray-600">Metrics Won</span><span id="overview-wins" class="font-bold text-lg">-</span></div>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">Last 12 Months</h3>
          <div class="h-48"><canvas id="chart-overview"></canvas></div>
        </div>
      </div>
      
      <!-- Signal Tab -->
      <div id="content-signal" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Current Signal</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div><p class="text-sm text-gray-500">Signal Date</p><p id="signal-asof" class="text-lg font-semibold font-mono">-</p></div>
            <div><p class="text-sm text-gray-500">Execution Date</p><p id="signal-exec" class="text-lg font-semibold font-mono">-</p></div>
            <div><p class="text-sm text-gray-500">Regime</p><span id="signal-regime" class="inline-block px-3 py-1 text-sm font-semibold rounded-full regime-LOW">-</span></div>
            <div><p class="text-sm text-gray-500">Equity Scalar</p><p id="signal-scalar" class="text-lg font-semibold">-</p></div>
          </div>
          <div class="border-t pt-4">
            <h3 class="font-semibold text-gray-700 mb-3">Target Weights</h3>
            <div id="weights-container" class="max-w-lg"></div>
          </div>
        </div>
      </div>
      
      <!-- Risk Drivers Tab -->
      <div id="content-drivers" class="tab-content hidden">
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <div class="bg-white rounded-lg border p-4">
            <h3 class="font-semibold text-gray-700 mb-3">Current Risk Inputs</h3>
            <div class="space-y-2">
              <div class="flex justify-between"><span class="text-sm text-gray-600">Vol Percentile</span><span id="current-vol" class="font-mono">-</span></div>
              <div class="flex justify-between"><span class="text-sm text-gray-600">Hill Alpha</span><span id="current-hill" class="font-mono">-</span></div>
              <div class="flex justify-between"><span class="text-sm text-gray-600">Hurst</span><span id="current-hurst" class="font-mono">-</span></div>
              <div class="flex justify-between border-t pt-2"><span class="font-semibold">Risk Score</span><span id="current-risk" class="font-mono font-bold">-</span></div>
            </div>
          </div>
          <div class="bg-white rounded-lg border p-4">
            <h3 class="font-semibold text-gray-700 mb-3">Thresholds</h3>
            <div class="space-y-2">
              <div class="flex justify-between"><span class="text-gray-600">Median</span><span id="thresh-median" class="font-mono">-</span></div>
              <div class="flex justify-between"><span class="text-gray-600">75th</span><span id="thresh-75" class="font-mono">-</span></div>
            </div>
          </div>
          <div class="bg-white rounded-lg border p-4">
            <h3 class="font-semibold text-gray-700 mb-3">Regime Rules</h3>
            <ul class="text-sm space-y-1 text-gray-600">
              <li><b>LOW:</b> Score &lt; median</li>
              <li><b>MID:</b> Score &ge; median, &lt; 75th</li>
              <li><b>HIGH:</b> Score &ge; 75th</li>
              <li><b>CRISIS:</b> HIGH + tail risk</li>
            </ul>
          </div>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Risk Score History</h2>
          <div class="h-80"><canvas id="chart-drivers"></canvas></div>
        </div>
      </div>
      
      <!-- Regimes Tab -->
      <div id="content-regime" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Regime History</h2>
          <p class="text-sm text-gray-500 mb-4">Each box = 1 month</p>
          <div id="regime-timeline" class="flex gap-1 flex-wrap mb-6"></div>
          <h3 class="font-semibold text-gray-700 mb-3">Distribution</h3>
          <div id="regime-distribution"></div>
        </div>
      </div>
      
      <!-- vs 60/40 Tab -->
      <div id="content-vs6040" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">FRAR vs 60/40</h2>
          <table class="w-full text-sm mb-6">
            <thead><tr class="bg-gray-50">
              <th class="px-4 py-2 text-left">Metric</th>
              <th class="px-4 py-2 text-right">60/40</th>
              <th class="px-4 py-2 text-right">FRAR Net</th>
              <th class="px-4 py-2 text-center">Winner</th>
            </tr></thead>
            <tbody id="vs6040-table"></tbody>
          </table>
        </div>
        <div class="bg-white rounded-lg border p-6 mb-6">
          <h3 class="font-semibold mb-4">Equity Curves</h3>
          <div class="h-80"><canvas id="chart-vs6040"></canvas></div>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <h3 class="font-semibold mb-4">Annual Returns</h3>
          <div class="h-64"><canvas id="chart-annual"></canvas></div>
          <p id="annual-summary" class="text-sm text-gray-600 mt-4 text-center">-</p>
        </div>
      </div>
      
      <!-- Performance Tab -->
      <div id="content-performance" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Performance Summary</h2>
          <table class="w-full text-sm">
            <thead><tr class="bg-gray-50">
              <th class="px-3 py-2 text-left">Strategy</th>
              <th class="px-3 py-2 text-right">CAGR</th>
              <th class="px-3 py-2 text-right">Vol</th>
              <th class="px-3 py-2 text-right">Sharpe</th>
              <th class="px-3 py-2 text-right">Max DD</th>
              <th class="px-3 py-2 text-right">Calmar</th>
            </tr></thead>
            <tbody id="performance-table"></tbody>
          </table>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <h3 class="font-semibold mb-4">Equity Curves</h3>
          <div class="h-96"><canvas id="chart-equity"></canvas></div>
        </div>
      </div>
      
      <!-- Costs Tab -->
      <div id="content-costs" class="tab-content hidden">
        <div class="bg-white rounded-lg border p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Turnover</h2>
          <table class="w-full text-sm">
            <thead><tr class="bg-gray-50">
              <th class="px-3 py-2 text-left">Strategy</th>
              <th class="px-3 py-2 text-right">Turnover</th>
              <th class="px-3 py-2 text-right">Cost Drag</th>
            </tr></thead>
            <tbody id="turnover-table"></tbody>
          </table>
        </div>
        <div class="bg-white rounded-lg border p-6">
          <h3 class="font-semibold mb-4">Cost Sensitivity</h3>
          <div class="flex gap-2 mb-4" id="cost-buttons"></div>
          <div id="cost-details" class="bg-blue-50 rounded p-4 grid grid-cols-4 gap-4 text-center mb-4"></div>
          <div class="h-64"><canvas id="chart-costs"></canvas></div>
        </div>
      </div>
      
      <!-- Health Tab -->
      <div id="content-health" class="tab-content hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-lg border p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Data Health</h2>
            <div id="health-status" class="rounded-lg p-4 text-center bg-green-50 mb-4">
              <p class="text-sm text-gray-600">Validation</p>
              <p id="health-validation" class="text-2xl font-bold text-green-700">-</p>
            </div>
            <div class="space-y-2">
              <div class="flex justify-between"><span>Signal Date</span><span id="health-date" class="font-mono">-</span></div>
              <div class="flex justify-between"><span>Data Hash</span><span id="health-hash" class="font-mono">-</span></div>
            </div>
          </div>
          <div class="bg-white rounded-lg border p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Parity Check</h2>
            <div class="flex items-center gap-4 mb-4">
              <span id="parity-status" class="px-3 py-1 rounded bg-green-100 text-green-700 font-semibold">-</span>
              <span id="parity-wins" class="text-sm text-gray-600">-</span>
            </div>
            <div id="parity-grid" class="grid grid-cols-2 gap-3"></div>
          </div>
        </div>
        <div class="bg-white rounded-lg border p-6 mt-6">
          <h3 class="font-semibold mb-4">Required Files</h3>
          <div id="files-status" class="grid grid-cols-3 gap-3"></div>
        </div>
      </div>
      
    </main>
    
    <footer class="bg-white border-t mt-8">
      <div class="max-w-7xl mx-auto px-4 py-4 text-center text-xs text-gray-500">
        MV-FRAR Research Dashboard v1.3 | For research purposes only
      </div>
    </footer>
  </div>

<script>
// Configuration
var REQUIRED_FILES = ['manifest.json', 'latest_signal.json', 'metrics.json', 'drivers_timeseries.csv', 'equity_curves.csv', 'cost_sensitivity.json'];
var LINE_COLORS = { SPY_BH: '#3b82f6', '60_40': '#f59e0b', FRAR: '#10b981', FRAR_Net: '#059669' };
var DATA = {};
var CHARTS = {};
var FILE_STATUS = {};

// CSV Parser
function parseCSV(text) {
  var lines = text.trim().split('\n');
  var headers = lines[0].split(',');
  var result = [];
  for (var i = 1; i < lines.length; i++) {
    var values = lines[i].split(',');
    var row = {};
    for (var j = 0; j < headers.length; j++) {
      var h = headers[j].trim();
      var v = values[j] ? values[j].trim() : '';
      row[h] = v === '' ? null : (isNaN(v) ? v : parseFloat(v));
    }
    result.push(row);
  }
  return result;
}

// Data Loading
function loadJSON(file) {
  return fetch('./outputs/' + file + '?v=' + Date.now())
    .then(function(r) {
      if (!r.ok) throw new Error(file + ': HTTP ' + r.status);
      FILE_STATUS[file] = { ok: true };
      return r.json();
    })
    .catch(function(e) {
      FILE_STATUS[file] = { ok: false, error: e.message };
      throw e;
    });
}

function loadCSV(file) {
  return fetch('./outputs/' + file + '?v=' + Date.now())
    .then(function(r) {
      if (!r.ok) throw new Error(file + ': HTTP ' + r.status);
      FILE_STATUS[file] = { ok: true };
      return r.text();
    })
    .then(function(text) {
      return parseCSV(text);
    })
    .catch(function(e) {
      FILE_STATUS[file] = { ok: false, error: e.message };
      throw e;
    });
}

function loadAllData() {
  var errors = [];
  return Promise.all([
    loadJSON('manifest.json').then(function(d) { DATA.manifest = d; }).catch(function(e) { errors.push(e.message); }),
    loadJSON('latest_signal.json').then(function(d) { DATA.signal = d; }).catch(function(e) { errors.push(e.message); }),
    loadJSON('metrics.json').then(function(d) { DATA.metrics = d; }).catch(function(e) { errors.push(e.message); }),
    loadCSV('drivers_timeseries.csv').then(function(d) { DATA.drivers = d; }).catch(function(e) { errors.push(e.message); }),
    loadCSV('equity_curves.csv').then(function(d) { DATA.equity = d; }).catch(function(e) { errors.push(e.message); }),
    loadJSON('cost_sensitivity.json').then(function(d) { DATA.costs = d; }).catch(function(e) { errors.push(e.message); })
  ]).then(function() {
    return errors;
  });
}

// Helpers
function showTab(name) {
  var contents = document.querySelectorAll('.tab-content');
  for (var i = 0; i < contents.length; i++) contents[i].classList.add('hidden');
  var tabs = document.querySelectorAll('#tabs button');
  for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('tab-active');
  document.getElementById('content-' + name).classList.remove('hidden');
  document.getElementById('tab-' + name).classList.add('tab-active');
}

function formatDate(d) { return d ? d.split('T')[0] : '-'; }
function formatPct(v, dec) { return v != null ? (v * 100).toFixed(dec || 1) + '%' : '-'; }
function formatPctSigned(v, dec) { 
  if (v == null) return '-'; 
  var p = (v * 100).toFixed(dec || 1); 
  return v >= 0 ? '+' + p + '%' : p + '%'; 
}

// Render Header
function renderHeader() {
  var m = DATA.manifest || {};
  var s = DATA.signal || {};
  document.getElementById('header-version').textContent = m.version || '?';
  document.getElementById('header-signal-date').textContent = formatDate(m.latest_signal_date);
  var reg = s.regime || 'LOW';
  var el = document.getElementById('header-regime');
  el.textContent = reg;
  el.className = 'inline-block px-3 py-1 text-sm font-semibold rounded-full regime-' + reg;
}

// Render Overview
function renderOverview() {
  var s = DATA.signal || {};
  var m = DATA.metrics || {};
  var frar = (m.strategies && m.strategies.FRAR_Net) || {};
  var bench = (m.strategies && m.strategies['60_40']) || {};
  
  var reg = s.regime || 'LOW';
  var regDesc = { LOW: 'Full equity (100%)', MID: 'Reduced (80%)', HIGH: 'Minimal (50%)', CRISIS: 'Defensive (20%)' };
  document.getElementById('overview-regime').textContent = reg;
  document.getElementById('overview-regime').className = 'inline-block px-4 py-2 text-lg font-bold rounded-full regime-' + reg;
  document.getElementById('overview-regime-desc').textContent = regDesc[reg] || '-';
  document.getElementById('overview-scalar').textContent = s.scalar ? (s.scalar * 100).toFixed(0) + '%' : '-';
  document.getElementById('overview-date').textContent = formatDate(DATA.manifest && DATA.manifest.latest_signal_date);
  
  document.getElementById('overview-cagr').textContent = formatPct(frar.cagr, 2);
  document.getElementById('overview-sharpe').textContent = frar.sharpe ? frar.sharpe.toFixed(3) : '-';
  document.getElementById('overview-maxdd').textContent = formatPct(frar.max_dd, 1);
  document.getElementById('overview-calmar').textContent = frar.calmar ? frar.calmar.toFixed(3) : '-';
  
  var cagrD = (frar.cagr || 0) - (bench.cagr || 0);
  var ddD = (bench.max_dd || 0) - (frar.max_dd || 0);
  document.getElementById('overview-vs-cagr').textContent = formatPctSigned(cagrD, 2);
  document.getElementById('overview-vs-cagr').className = 'font-semibold ' + (cagrD >= 0 ? 'text-green-600' : 'text-red-600');
  document.getElementById('overview-vs-dd').textContent = formatPctSigned(ddD, 1);
  document.getElementById('overview-vs-dd').className = 'font-semibold ' + (ddD >= 0 ? 'text-green-600' : 'text-red-600');
  
  var parity = m.parity_check || {};
  document.getElementById('overview-wins').textContent = (parity.parity_wins || 0) + '/4';
  
  renderOverviewChart();
}

function renderOverviewChart() {
  var eq = (DATA.equity || []).filter(function(d) { return d.FRAR_Net != null; }).slice(-252);
  if (eq.length === 0) return;
  
  var s1 = eq[0].FRAR_Net;
  var s2 = eq[0]['60_40'];
  var norm = eq.map(function(d) { return { date: d.date, FRAR_Net: d.FRAR_Net / s1, '60_40': d['60_40'] / s2 }; });
  var sam = norm.filter(function(d, i) { return i % 5 === 0; });
  
  if (CHARTS.overview) CHARTS.overview.destroy();
  CHARTS.overview = new Chart(document.getElementById('chart-overview'), {
    type: 'line',
    data: {
      labels: sam.map(function(d) { return d.date; }),
      datasets: [
        { label: 'FRAR Net', data: sam.map(function(d) { return d.FRAR_Net; }), borderColor: '#059669', borderWidth: 2, fill: false, pointRadius: 0 },
        { label: '60/40', data: sam.map(function(d) { return d['60_40']; }), borderColor: '#f59e0b', borderWidth: 2, fill: false, pointRadius: 0 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });
}

// Render Signal
function renderSignal() {
  var s = DATA.signal || {};
  document.getElementById('signal-asof').textContent = formatDate(s.as_of_date);
  document.getElementById('signal-exec').textContent = formatDate(s.execution_date);
  document.getElementById('signal-scalar').textContent = s.scalar != null ? (s.scalar * 100).toFixed(0) + '%' : '-';
  
  var reg = s.regime || 'LOW';
  var el = document.getElementById('signal-regime');
  el.textContent = reg;
  el.className = 'inline-block px-3 py-1 text-sm font-semibold rounded-full regime-' + reg;
  
  var w = s.executable_weights || {};
  var entries = Object.entries(w).sort(function(a, b) { return b[1] - a[1]; }).filter(function(e) { return e[1] > 0; });
  var html = '';
  entries.forEach(function(e) {
    var ticker = e[0], weight = e[1];
    html += '<div class="flex items-center gap-2 py-1">' +
      '<span class="w-12 text-sm font-mono">' + ticker + '</span>' +
      '<div class="flex-1 bg-gray-100 rounded h-5"><div class="h-full rounded bg-blue-500" style="width:' + (weight * 100) + '%"></div></div>' +
      '<span class="w-14 text-right text-sm font-mono">' + (weight * 100).toFixed(1) + '%</span></div>';
  });
  document.getElementById('weights-container').innerHTML = html;
}

// Render Drivers
function renderDrivers() {
  var drv = DATA.drivers || [];
  var lat = drv[drv.length - 1] || {};
  
  document.getElementById('current-vol').textContent = lat.vol_percentile ? lat.vol_percentile.toFixed(3) : '-';
  document.getElementById('current-hill').textContent = lat.hill_alpha ? lat.hill_alpha.toFixed(2) : '-';
  document.getElementById('current-hurst').textContent = lat.hurst ? lat.hurst.toFixed(3) : '-';
  document.getElementById('current-risk').textContent = lat.risk_score ? lat.risk_score.toFixed(3) : '-';
  document.getElementById('thresh-median').textContent = lat.threshold_median ? lat.threshold_median.toFixed(3) : '-';
  document.getElementById('thresh-75').textContent = lat.threshold_75 ? lat.threshold_75.toFixed(3) : '-';
  
  if (CHARTS.drivers) CHARTS.drivers.destroy();
  CHARTS.drivers = new Chart(document.getElementById('chart-drivers'), {
    type: 'line',
    data: {
      labels: drv.map(function(d) { return d.date; }),
      datasets: [
        { label: 'Risk Score', data: drv.map(function(d) { return d.risk_score; }), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, pointRadius: 1 },
        { label: 'Median', data: drv.map(function(d) { return d.threshold_median; }), borderColor: '#f97316', borderDash: [5, 5], fill: false, pointRadius: 0 },
        { label: '75th', data: drv.map(function(d) { return d.threshold_75; }), borderColor: '#dc2626', borderDash: [5, 5], fill: false, pointRadius: 0 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 1 } }, plugins: { legend: { position: 'bottom' } } }
  });
}

// Render Regimes
function renderRegimes() {
  var drv = DATA.drivers || [];
  var recent = drv.slice(-48);
  
  var colors = { LOW: '#dcfce7', MID: '#fef9c3', HIGH: '#fed7aa', CRISIS: '#fecaca' };
  var txtColors = { LOW: '#166534', MID: '#854d0e', HIGH: '#9a3412', CRISIS: '#991b1b' };
  
  var html = '';
  recent.forEach(function(d) {
    var st = d.risk_state || 'LOW';
    html += '<div class="w-7 h-7 rounded text-xs font-bold flex items-center justify-center" style="background:' + colors[st] + ';color:' + txtColors[st] + '" title="' + d.date + ': ' + st + '">' + st[0] + '</div>';
  });
  document.getElementById('regime-timeline').innerHTML = html;
  
  var counts = (DATA.metrics && DATA.metrics.regime_counts) || {};
  var total = 0;
  ['LOW', 'MID', 'HIGH', 'CRISIS'].forEach(function(r) { total += counts[r] || 0; });
  var borders = { LOW: '#22c55e', MID: '#eab308', HIGH: '#f97316', CRISIS: '#ef4444' };
  
  var distHtml = '';
  ['LOW', 'MID', 'HIGH', 'CRISIS'].forEach(function(r) {
    var c = counts[r] || 0;
    var pct = total > 0 ? ((c / total) * 100).toFixed(0) : 0;
    distHtml += '<div class="flex items-center gap-3 mb-2">' +
      '<span class="w-16 px-2 py-1 text-xs font-semibold rounded-full regime-' + r + ' text-center">' + r + '</span>' +
      '<div class="flex-1 bg-gray-100 rounded h-4"><div class="h-full rounded" style="width:' + pct + '%;background:' + borders[r] + '"></div></div>' +
      '<span class="text-sm font-mono w-24 text-right">' + c + ' mo (' + pct + '%)</span></div>';
  });
  document.getElementById('regime-distribution').innerHTML = distHtml;
}

// Render vs 60/40
function renderVs6040() {
  var m = DATA.metrics || {};
  var frar = (m.strategies && m.strategies.FRAR_Net) || {};
  var bench = (m.strategies && m.strategies['60_40']) || {};
  
  var metrics = [
    { n: 'CAGR', f: frar.cagr, b: bench.cagr, fmt: function(v) { return formatPct(v, 2); }, hb: true },
    { n: 'Volatility', f: frar.vol, b: bench.vol, fmt: function(v) { return formatPct(v, 1); }, hb: false },
    { n: 'Sharpe', f: frar.sharpe, b: bench.sharpe, fmt: function(v) { return v ? v.toFixed(3) : '-'; }, hb: true },
    { n: 'Max DD', f: frar.max_dd, b: bench.max_dd, fmt: function(v) { return formatPct(v, 1); }, hb: false },
    { n: 'Calmar', f: frar.calmar, b: bench.calmar, fmt: function(v) { return v ? v.toFixed(3) : '-'; }, hb: true }
  ];
  
  var html = '';
  metrics.forEach(function(x) {
    var diff = (x.f || 0) - (x.b || 0);
    var better = x.hb ? diff > 0 : diff < 0;
    html += '<tr><td class="px-4 py-2 font-medium">' + x.n + '</td>' +
      '<td class="px-4 py-2 text-right font-mono ' + (!better ? 'winner' : '') + '">' + x.fmt(x.b) + '</td>' +
      '<td class="px-4 py-2 text-right font-mono ' + (better ? 'winner' : '') + '">' + x.fmt(x.f) + '</td>' +
      '<td class="px-4 py-2 text-center font-semibold ' + (better ? 'text-green-600' : 'text-amber-600') + '">' + (better ? 'FRAR' : '60/40') + '</td></tr>';
  });
  document.getElementById('vs6040-table').innerHTML = html;
  
  renderVs6040Chart();
  renderAnnualChart();
}

function renderVs6040Chart() {
  var eq = (DATA.equity || []).filter(function(d) { return d.FRAR_Net != null; });
  var sam = eq.filter(function(d, i) { return i % 10 === 0; });
  
  if (CHARTS.vs6040) CHARTS.vs6040.destroy();
  CHARTS.vs6040 = new Chart(document.getElementById('chart-vs6040'), {
    type: 'line',
    data: {
      labels: sam.map(function(d) { return d.date; }),
      datasets: [
        { label: '60/40', data: sam.map(function(d) { return d['60_40']; }), borderColor: '#f59e0b', borderWidth: 2, fill: false, pointRadius: 0 },
        { label: 'FRAR Net', data: sam.map(function(d) { return d.FRAR_Net; }), borderColor: '#059669', borderWidth: 2.5, fill: false, pointRadius: 0 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });
}

function renderAnnualChart() {
  var eq = DATA.equity || [];
  var years = {};
  eq.forEach(function(d) {
    var y = d.date ? d.date.slice(0, 4) : null;
    if (!y || !d.FRAR_Net) return;
    if (!years[y]) years[y] = { first: d, last: d };
    years[y].last = d;
  });
  
  var ann = [];
  Object.keys(years).sort().forEach(function(y) {
    if (y < '2007') return;
    var data = years[y];
    ann.push({
      y: y,
      f: data.last.FRAR_Net / data.first.FRAR_Net - 1,
      b: data.last['60_40'] / data.first['60_40'] - 1
    });
  });
  
  var wins = ann.filter(function(d) { return d.f > d.b; }).length;
  document.getElementById('annual-summary').textContent = 'FRAR beat 60/40 in ' + wins + '/' + ann.length + ' years';
  
  if (CHARTS.annual) CHARTS.annual.destroy();
  CHARTS.annual = new Chart(document.getElementById('chart-annual'), {
    type: 'bar',
    data: {
      labels: ann.map(function(d) { return d.y; }),
      datasets: [
        { label: '60/40', data: ann.map(function(d) { return d.b * 100; }), backgroundColor: '#fcd34d' },
        { label: 'FRAR Net', data: ann.map(function(d) { return d.f * 100; }), backgroundColor: '#34d399' }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { ticks: { callback: function(v) { return v + '%'; } } } } }
  });
}

// Render Performance
function renderPerformance() {
  var m = DATA.metrics || {};
  var strats = ['SPY_BH', '60_40', 'FRAR', 'FRAR_Net'];
  
  var html = '';
  strats.forEach(function(n) {
    var s = (m.strategies && m.strategies[n]) || {};
    var isFRAR = n.indexOf('FRAR') >= 0;
    html += '<tr class="' + (isFRAR ? 'bg-green-50' : '') + '">' +
      '<td class="px-3 py-2 font-medium">' + n + '</td>' +
      '<td class="px-3 py-2 text-right font-mono">' + formatPct(s.cagr, 2) + '</td>' +
      '<td class="px-3 py-2 text-right font-mono">' + formatPct(s.vol, 1) + '</td>' +
      '<td class="px-3 py-2 text-right font-mono">' + (s.sharpe ? s.sharpe.toFixed(3) : '-') + '</td>' +
      '<td class="px-3 py-2 text-right font-mono">' + formatPct(s.max_dd, 1) + '</td>' +
      '<td class="px-3 py-2 text-right font-mono">' + (s.calmar ? s.calmar.toFixed(3) : '-') + '</td></tr>';
  });
  document.getElementById('performance-table').innerHTML = html;
  
  renderEquityChart();
}

function renderEquityChart() {
  var eq = (DATA.equity || []).filter(function(d) { return d.FRAR != null; });
  var sam = eq.filter(function(d, i) { return i % 5 === 0; });
  
  if (CHARTS.equity) CHARTS.equity.destroy();
  CHARTS.equity = new Chart(document.getElementById('chart-equity'), {
    type: 'line',
    data: {
      labels: sam.map(function(d) { return d.date; }),
      datasets: [
        { label: 'SPY', data: sam.map(function(d) { return d.SPY_BH; }), borderColor: '#3b82f6', borderWidth: 1.5, fill: false, pointRadius: 0 },
        { label: '60/40', data: sam.map(function(d) { return d['60_40']; }), borderColor: '#f59e0b', borderWidth: 1.5, fill: false, pointRadius: 0 },
        { label: 'FRAR', data: sam.map(function(d) { return d.FRAR; }), borderColor: '#10b981', borderWidth: 2.5, fill: false, pointRadius: 0 },
        { label: 'FRAR Net', data: sam.map(function(d) { return d.FRAR_Net; }), borderColor: '#059669', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });
}

// Render Costs
function renderCosts() {
  var t = (DATA.metrics && DATA.metrics.turnovers) || {};
  var html = '';
  Object.keys(t).forEach(function(n) {
    var v = t[n];
    html += '<tr class="' + (n === 'FRAR' ? 'bg-green-50' : '') + '">' +
      '<td class="px-3 py-2 font-medium">' + n + '</td>' +
      '<td class="px-3 py-2 text-right font-mono">' + (v.annualized ? v.annualized.toFixed(2) : '-') + 'x</td>' +
      '<td class="px-3 py-2 text-right font-mono">' + (v.cost_drag_bps ? v.cost_drag_bps.toFixed(1) : '-') + ' bps</td></tr>';
  });
  document.getElementById('turnover-table').innerHTML = html;
  
  var c = DATA.costs || {};
  var lvls = c.cost_levels_bps || [];
  var rows = c.rows || [];
  
  var btnHtml = '';
  lvls.forEach(function(l) {
    var isActive = l === 10;
    btnHtml += '<button onclick="selectCost(' + l + ')" id="cost-btn-' + l + '" class="px-3 py-1 rounded text-sm font-mono ' + (isActive ? 'bg-blue-600 text-white' : 'bg-gray-100') + '">' + l + ' bps</button>';
  });
  document.getElementById('cost-buttons').innerHTML = btnHtml;
  selectCost(10);
  
  if (CHARTS.costs) CHARTS.costs.destroy();
  CHARTS.costs = new Chart(document.getElementById('chart-costs'), {
    type: 'bar',
    data: {
      labels: rows.map(function(r) { return r.cost_bps + ' bps'; }),
      datasets: [{ label: 'CAGR', data: rows.map(function(r) { return r.cagr * 100; }), backgroundColor: '#93c5fd' }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: function(v) { return v.toFixed(1) + '%'; } } } } }
  });
}

function selectCost(cost) {
  var btns = document.querySelectorAll('#cost-buttons button');
  for (var i = 0; i < btns.length; i++) {
    btns[i].className = btns[i].id === 'cost-btn-' + cost ? 'px-3 py-1 rounded text-sm font-mono bg-blue-600 text-white' : 'px-3 py-1 rounded text-sm font-mono bg-gray-100';
  }
  var rows = (DATA.costs && DATA.costs.rows) || [];
  var r = rows.find(function(x) { return x.cost_bps === cost; });
  if (r) {
    document.getElementById('cost-details').innerHTML = 
      '<div><p class="text-xs text-gray-500">CAGR</p><p class="text-lg font-semibold">' + formatPct(r.cagr, 2) + '</p></div>' +
      '<div><p class="text-xs text-gray-500">Sharpe</p><p class="text-lg font-semibold">' + (r.sharpe ? r.sharpe.toFixed(3) : '-') + '</p></div>' +
      '<div><p class="text-xs text-gray-500">Max DD</p><p class="text-lg font-semibold">' + formatPct(r.max_dd, 1) + '</p></div>' +
      '<div><p class="text-xs text-gray-500">Calmar</p><p class="text-lg font-semibold">' + (r.calmar ? r.calmar.toFixed(3) : '-') + '</p></div>';
  }
}

// Render Health
function renderHealth() {
  var m = DATA.manifest || {};
  var v = (DATA.metrics && DATA.metrics.validation) || {};
  var p = (DATA.metrics && DATA.metrics.parity_check) || {};
  
  document.getElementById('health-validation').textContent = v.status || '?';
  document.getElementById('health-validation').className = 'text-2xl font-bold ' + (v.status === 'PASS' ? 'text-green-700' : 'text-red-700');
  document.getElementById('health-date').textContent = formatDate(m.latest_signal_date);
  document.getElementById('health-hash').textContent = m.data_hash ? m.data_hash.slice(0, 12) : '-';
  
  document.getElementById('parity-status').textContent = p.parity_status || '?';
  document.getElementById('parity-wins').textContent = 'FRAR wins ' + (p.parity_wins || 0) + '/4';
  
  var comps = p.parity_components || {};
  var gridHtml = '';
  Object.keys(comps).forEach(function(k) {
    var x = comps[k];
    gridHtml += '<div class="rounded-lg p-3 ' + (x.frar_wins ? 'bg-green-50' : 'bg-amber-50') + '">' +
      '<p class="text-xs text-gray-500 uppercase">' + k.replace('_', ' ') + '</p>' +
      '<p class="text-sm font-semibold">' + (x.frar_wins ? 'âœ“ FRAR' : 'âœ— 60/40') + '</p></div>';
  });
  document.getElementById('parity-grid').innerHTML = gridHtml;
  
  var filesHtml = '';
  REQUIRED_FILES.forEach(function(f) {
    var ok = FILE_STATUS[f] && FILE_STATUS[f].ok;
    filesHtml += '<div class="flex items-center gap-2 p-2 rounded ' + (ok ? 'bg-green-50' : 'bg-red-50') + '">' +
      '<span class="' + (ok ? 'text-green-600' : 'text-red-600') + '">' + (ok ? 'âœ“' : 'âœ—') + '</span>' +
      '<span class="text-sm font-mono">' + f + '</span></div>';
  });
  document.getElementById('files-status').innerHTML = filesHtml;
}

// Initialize
function init() {
  loadAllData().then(function(errors) {
    document.getElementById('loading').classList.add('hidden');
    
    if (errors.length > 0 && Object.keys(DATA).length < 3) {
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-details').innerHTML = errors.map(function(e) { return 'â€¢ ' + e; }).join('<br>');
      return;
    }
    
    document.getElementById('app').classList.remove('hidden');
    
    renderHeader();
    renderOverview();
    renderSignal();
    renderDrivers();
    renderRegimes();
    renderVs6040();
    renderPerformance();
    renderCosts();
    renderHealth();
  }).catch(function(e) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('error').classList.remove('hidden');
    document.getElementById('error-details').textContent = 'Unexpected error: ' + e.message;
  });
}

init();
</script>
</body>
</html>
